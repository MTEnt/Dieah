<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Dieah - OpenClaw Agent Config</title>
  <link href="styles/tokens.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#6366F1",
            "primary-dark": "#4F46E5",
            "primary-dim": "#4338ca",
            "background-dark": "#0D0D0D",
            "surface-dark": "#171717",
            "surface-hover": "#202020",
            "surface-dim": "#121212",
            "surface-border": "#262626",
            "border-subtle": "#27272A",
            "text-secondary": "#A1A1AA",
            "terminal-bg": "#0a0a0a",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            mono: ["JetBrains Mono", "monospace"],
          },
          boxShadow: {
            glow: "0 0 20px -5px rgba(99, 102, 241, 0.35)",
          },
        },
      },
    };
  </script>
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0D0D0D; }
    ::-webkit-scrollbar-thumb { background: #262626; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
    .scan-line {
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
      background-size: 100% 4px;
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 10;
      opacity: 0.05;
    }
    .chart-gradient {
      fill: url(#gradient);
    }
    select {
      background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCLsiypim9Yo-JIz8kFXYD7exDXWJN8Yvou8PmNUWtgWkykswyjaREVAdfdbLw-FOafnL5HTJEgwuAvDLyrZR6bthO8WqcojQn9k3JEh4FVe_vgqnaQoZvc7SZJg5dNrfMIVsVAitMxFQs6F6xESBVAtjYKeVMVPWxKk0FoBFXE90dTFecA420K5H32eml2Lx2iuqTmsG2Ulg4Tz8zXngIcJDaQDOWiQVdTgSWv9igQIi2D_hO93XuLqRBQbMzLDArR6HPL4fPxeFs);
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  </style>
</head>
<body class="bg-background-dark text-slate-200 font-display antialiased overflow-hidden selection:bg-primary/30 selection:text-white">
  <div class="relative flex h-screen w-full bg-background-dark overflow-hidden">
    <div class="pointer-events-none absolute -top-20 -right-24 h-72 w-72 rounded-full bg-primary/20 blur-[120px]"></div>
    <div class="pointer-events-none absolute bottom-[-140px] left-10 h-80 w-80 rounded-full bg-indigo-500/10 blur-[140px]"></div>

    <aside id="app-sidebar" class="flex w-16 lg:w-64 flex-col border-r border-surface-border bg-[#111111] z-20 transition-all duration-300">
      <div class="flex flex-col h-full p-3 lg:p-4">
        <div class="flex gap-3 mb-8 px-2 items-center">
          <div class="bg-primary/10 rounded-lg size-10 flex items-center justify-center border border-primary/20 shrink-0">
            <img src="assets/logo-pulse-ribbon.svg" alt="Dieah" class="size-6" />
          </div>
          <div class="hidden lg:flex flex-col justify-center">
            <h1 class="text-white text-base font-bold leading-none tracking-tight">Dieah</h1>
            <p class="text-slate-500 text-[10px] font-mono mt-1 uppercase tracking-wide">OpenClaw UI</p>
          </div>
        </div>
        <nav class="flex flex-col gap-1 flex-1">
          <a id="nav-overview" data-view="overview" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-colors group" href="#">
            <span class="material-symbols-outlined text-[20px] group-hover:text-primary transition-colors">dashboard</span>
            <p class="text-sm font-medium hidden lg:block">Overview</p>
          </a>
          <a id="nav-agents" data-view="agents" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-colors group" href="#">
            <span class="material-symbols-outlined text-[20px] group-hover:text-primary transition-colors">smart_toy</span>
            <p class="text-sm font-medium hidden lg:block">Agents</p>
          </a>
          <a id="nav-setup" data-view="setup" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary border border-primary/10 shadow-glow" href="#">
            <span class="material-symbols-outlined text-[20px] fill-1">cable</span>
            <p class="text-sm font-semibold hidden lg:block">Agent Config</p>
          </a>
          <a id="nav-skills" data-view="skills" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-colors group" href="#">
            <span class="material-symbols-outlined text-[20px] group-hover:text-primary transition-colors">apps</span>
            <p class="text-sm font-medium hidden lg:block">Skills</p>
          </a>
        </nav>
        <div class="mt-auto flex flex-col gap-2">
          <a id="nav-settings" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-white/5 hover:text-white transition-colors group" href="#">
            <span class="material-symbols-outlined text-[20px] group-hover:text-primary transition-colors">settings</span>
            <p class="text-sm font-medium hidden lg:block">Settings</p>
          </a>
        </div>
      </div>


    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-[#050505]">
      <header id="app-header" class="h-14 border-b border-surface-border flex items-center justify-between px-6 bg-[#0D0D0D] z-10">
        <div class="flex items-center gap-4 text-sm breadcrumbs text-slate-500 font-mono">
          <button id="sidebar-toggle" class="text-slate-400 hover:text-white transition-colors">
            <span class="material-symbols-outlined text-[20px]">dock_to_left</span>
          </button>
          <span class="hover:text-white cursor-pointer transition-colors">dieah</span>
          <span class="text-slate-700">/</span>
          <span class="hover:text-white cursor-pointer transition-colors">agent-config</span>
          <span class="text-slate-700">/</span>
          <span id="header-view" class="text-primary font-bold">openclaw</span>
        </div>
        <div class="flex items-center gap-3">
          <div id="gateway-offline-badge" class="hidden px-2.5 py-1 rounded bg-red-500/10 border border-red-500/30 text-[10px] font-mono text-red-300">
            OFFLINE
          </div>
          <div id="gateway-pill" class="flex items-center gap-2 px-3 py-1 rounded bg-slate-900 border border-slate-800 text-[10px] font-mono text-slate-400">
            <div id="gateway-pill-dot" class="size-2 rounded-full bg-slate-600"></div>
            <span id="gateway-pill-text">GATEWAY IDLE</span>
          </div>
          <button class="text-slate-400 hover:text-white transition-colors">
            <span class="material-symbols-outlined text-[20px]">settings</span>
          </button>
        </div>
      </header>

      <div id="profile-toast" class="hidden fixed top-6 right-6 z-40 px-4 py-2 rounded-lg bg-[#111111] border border-surface-border text-xs font-mono text-slate-300 shadow-lg">
        Loading profile...
      </div>
      <div id="conn-toast" class="hidden fixed top-16 right-6 z-40 px-4 py-2 rounded-lg bg-[#111111] border border-surface-border text-xs font-mono text-amber-300 shadow-lg">
        Reconnecting...
      </div>

      <div id="view-overview" class="hidden flex-1 overflow-hidden flex flex-col">
        <div class="flex-1 min-h-0 overflow-y-auto bg-background-dark relative text-gray-900 dark:text-gray-200">
          <header class="h-16 flex items-center justify-between px-8 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-200 dark:border-border-subtle">
            <div class="flex items-center gap-4">
              <button id="sidebar-toggle-overview" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-surface-hover transition-colors">
                <span class="material-symbols-outlined text-[20px]">dock_to_left</span>
              </button>
              <h1 class="text-lg font-semibold text-gray-800 dark:text-white">Overview</h1>
              <div class="h-4 w-px bg-gray-300 dark:bg-gray-700 mx-2"></div>
              <div class="flex items-center gap-3">
                <div class="relative">
                  <select class="appearance-none bg-gray-100 dark:bg-surface-dark border border-gray-200 dark:border-border-subtle text-gray-700 dark:text-gray-300 text-sm rounded-md pl-3 pr-8 py-1.5 focus:ring-1 focus:ring-primary focus:border-primary outline-none cursor-pointer transition-shadow hover:border-gray-300 dark:hover:border-gray-600">
                    <option>All Models</option>
                    <option>Claude Opus 4.5</option>
                    <option>Gemini 1.5 Pro</option>
                    <option>OpenAI Codex</option>
                  </select>
                </div>
                <div class="relative">
                  <select class="appearance-none bg-gray-100 dark:bg-surface-dark border border-gray-200 dark:border-border-subtle text-gray-700 dark:text-gray-300 text-sm rounded-md pl-3 pr-8 py-1.5 focus:ring-1 focus:ring-primary focus:border-primary outline-none cursor-pointer transition-shadow hover:border-gray-300 dark:hover:border-gray-600">
                    <option>Last 7 Days</option>
                    <option>Last 30 Days</option>
                    <option>This Quarter</option>
                    <option>Year to Date</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <button class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-surface-hover transition-colors" onclick="document.documentElement.classList.toggle('dark')">
                <span class="material-symbols-outlined block dark:hidden">dark_mode</span>
                <span class="material-symbols-outlined hidden dark:block">light_mode</span>
              </button>
              <button id="overview-new-assistant" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all shadow-lg shadow-primary/20 hover:shadow-primary/30 border border-transparent">
                <span class="material-symbols-outlined text-lg">add</span>
                New Assistant
              </button>
            </div>
          </header>

          <div class="p-8 space-y-6 max-w-[1600px] mx-auto">
            <div id="overview-loading" class="hidden px-4 py-3 rounded-lg border border-primary/20 bg-primary/10 text-primary text-sm font-medium flex items-center gap-3">
              <span class="material-symbols-outlined text-base">sync</span>
              <span>Loading existing models...</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle p-5 rounded-xl shadow-sm hover:border-gray-300 dark:hover:border-gray-600 transition-colors group">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total Messages</p>
                    <h3 id="dash-total-messages" class="text-2xl font-bold text-gray-900 dark:text-white mt-1 group-hover:text-primary transition-colors">—</h3>
                  </div>
                  <div class="p-2 bg-primary/10 rounded-lg text-primary">
                    <span class="material-symbols-outlined">forum</span>
                  </div>
                </div>
                <div id="dash-total-messages-meta" class="mt-3 text-xs text-gray-400 dark:text-gray-500">No activity yet.</div>
              </div>
              <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle p-5 rounded-xl shadow-sm hover:border-gray-300 dark:hover:border-gray-600 transition-colors group">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Active Assistants</p>
                    <h3 id="dash-active-agents" class="text-2xl font-bold text-gray-900 dark:text-white mt-1 group-hover:text-primary transition-colors">—</h3>
                  </div>
                  <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-500">
                    <span class="material-symbols-outlined">smart_toy</span>
                  </div>
                </div>
                <div id="dash-active-agents-meta" class="mt-3 text-xs text-gray-400 dark:text-gray-500">Not connected.</div>
              </div>
              <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle p-5 rounded-xl shadow-sm hover:border-gray-300 dark:hover:border-gray-600 transition-colors group">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Avg Response</p>
                    <h3 id="dash-avg-response" class="text-2xl font-bold text-gray-900 dark:text-white mt-1 group-hover:text-primary transition-colors">—</h3>
                  </div>
                  <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500">
                    <span class="material-symbols-outlined">timer</span>
                  </div>
                </div>
                <div id="dash-avg-response-meta" class="mt-3 text-xs text-gray-400 dark:text-gray-500">No responses yet.</div>
              </div>
              <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle p-5 rounded-xl shadow-sm hover:border-gray-300 dark:hover:border-gray-600 transition-colors group">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Tokens Today</p>
                    <h3 id="dash-tokens-today" class="text-2xl font-bold text-gray-900 dark:text-white mt-1 group-hover:text-primary transition-colors">—</h3>
                  </div>
                  <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                    <span class="material-symbols-outlined">data_usage</span>
                  </div>
                </div>
                <div id="dash-tokens-today-meta" class="mt-3 text-xs text-gray-400 dark:text-gray-500">No tokens yet.</div>
              </div>
            </div>

            <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle rounded-xl shadow-sm p-6">
              <div class="flex justify-between items-center mb-6">
                <div>
                  <h3 class="text-base font-semibold text-gray-900 dark:text-white">Token Usage Activity</h3>
                  <p class="text-sm text-gray-500 dark:text-text-secondary mt-1">Daily token consumption across all models</p>
                </div>
                <div class="flex items-center gap-4 text-xs">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-primary"></span>
                    <span class="text-gray-500 dark:text-gray-400">Total Tokens</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-700"></span>
                    <span class="text-gray-500 dark:text-gray-400">Prompt Tokens</span>
                  </div>
                </div>
              </div>
              <div id="overview-chart" class="w-full h-72 relative">
                <svg class="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 1000 300">
                  <defs>
                    <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
                      <stop offset="0%" stop-color="#6366F1" stop-opacity="0.3"></stop>
                      <stop offset="100%" stop-color="#6366F1" stop-opacity="0"></stop>
                    </linearGradient>
                  </defs>
                  <line class="text-gray-200 dark:text-gray-800" stroke="currentColor" stroke-opacity="0.4" x1="0" x2="1000" y1="299" y2="299"></line>
                  <line class="text-gray-200 dark:text-gray-800" stroke="currentColor" stroke-dasharray="6" stroke-opacity="0.4" x1="0" x2="1000" y1="225" y2="225"></line>
                  <line class="text-gray-200 dark:text-gray-800" stroke="currentColor" stroke-dasharray="6" stroke-opacity="0.4" x1="0" x2="1000" y1="150" y2="150"></line>
                  <line class="text-gray-200 dark:text-gray-800" stroke="currentColor" stroke-dasharray="6" stroke-opacity="0.4" x1="0" x2="1000" y1="75" y2="75"></line>
                  <path id="overview-chart-line" d="M0,260 L1000,260" fill="none" stroke="#6366F1" stroke-linecap="round" stroke-width="3" vector-effect="non-scaling-stroke"></path>
                  <path id="overview-chart-area" class="chart-gradient" d="M0,260 L1000,260 V300 H0 Z"></path>
                </svg>
                <div id="overview-chart-hit" class="absolute inset-x-0 top-0 bottom-6 cursor-crosshair"></div>
                <div id="overview-chart-marker" class="absolute top-0 bottom-6 w-px bg-primary/40 hidden pointer-events-none"></div>
                <div id="overview-chart-dot" class="absolute size-2 rounded-full bg-primary shadow-[0_0_12px_rgba(99,102,241,0.6)] hidden pointer-events-none"></div>
                <div id="overview-chart-tooltip" class="absolute z-20 hidden pointer-events-none bg-[#111111] border border-surface-border rounded-lg px-3 py-2 text-xs text-slate-200 shadow-xl w-44"></div>
                <div class="flex justify-between mt-4 text-xs text-gray-400 dark:text-gray-500 font-medium px-1">
                  <span id="overview-chart-label-0">--</span>
                  <span id="overview-chart-label-1">--</span>
                  <span id="overview-chart-label-2">--</span>
                  <span id="overview-chart-label-3">--</span>
                  <span id="overview-chart-label-4">--</span>
                  <span id="overview-chart-label-5">--</span>
                  <span id="overview-chart-label-6">--</span>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle rounded-xl shadow-sm overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-border-subtle flex justify-between items-center bg-gray-50/50 dark:bg-white/[0.02]">
                  <h3 class="text-base font-semibold text-gray-900 dark:text-white">Recent Conversations</h3>
                  <a id="overview-view-all" class="text-xs text-primary hover:text-primary-dark font-medium border border-primary/20 bg-primary/5 px-2 py-1 rounded transition-colors" href="#">View All</a>
                </div>
                <div id="overview-conversations" class="divide-y divide-gray-100 dark:divide-border-subtle"></div>
                <div id="overview-conversations-empty" class="p-6 text-sm text-gray-500 dark:text-gray-400">No conversations yet.</div>
              </div>

              <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-subtle rounded-xl shadow-sm p-6 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-base font-semibold text-gray-900 dark:text-white">Connected Models</h3>
                  <button class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                  </button>
                </div>
                <div id="overview-models-list" class="space-y-3 flex-1"></div>
                <div id="overview-models-empty" class="text-sm text-gray-500 dark:text-gray-400">No models detected.</div>
                <button class="w-full mt-4 py-2.5 text-xs font-medium text-gray-500 dark:text-gray-400 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg hover:border-primary hover:text-primary dark:hover:text-primary dark:hover:border-primary bg-transparent hover:bg-gray-50 dark:hover:bg-primary/5 transition-all flex items-center justify-center gap-2 group">
                  <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">add_link</span>
                  Connect New Model
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="view-skills" class="hidden flex-1 overflow-y-auto bg-[#0D0D0D]">
        <div class="max-w-5xl mx-auto p-8 space-y-8">
          <header class="flex flex-wrap items-end justify-between gap-4 border-b border-border-dark pb-6">
            <div>
              <h2 class="text-white text-3xl font-black tracking-tight">Skills</h2>
              <p class="text-slate-400 text-base">Curated marketplace with optional full catalog from ClawHub.</p>
            </div>
            <div class="flex items-center gap-2">
              <button id="skills-filter-curated" class="px-3 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono">Curated</button>
              <button id="skills-filter-all" class="px-3 h-9 rounded bg-slate-900 border border-slate-800 text-xs font-mono text-slate-300 hover:text-white">Show All</button>
              <button id="skills-refresh" class="px-3 h-9 rounded bg-slate-900 border border-slate-800 text-xs font-mono text-slate-300 hover:text-white">Refresh</button>
            </div>
          </header>

          <section class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-white">Installed Skills</p>
              <p id="skills-summary" class="text-xs font-mono text-slate-500">No data yet.</p>
            </div>
            <div id="skills-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
          </section>

          <section id="skills-curated" class="space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-white">Curated from ClawHub</h3>
              <span class="text-[11px] font-mono text-slate-500 uppercase tracking-wide">Recommended</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="border border-surface-border bg-[#111111] rounded-lg p-4">
                <p class="text-sm font-semibold text-white">Context Snapshot</p>
                <p class="text-xs text-slate-500 mt-2">Auto-save key context for long sessions.</p>
                <button class="mt-4 px-3 h-8 rounded bg-primary/10 border border-primary/20 text-xs font-mono text-primary hover:bg-primary/20">Install</button>
              </div>
              <div class="border border-surface-border bg-[#111111] rounded-lg p-4">
                <p class="text-sm font-semibold text-white">Multi-Agent Handoff</p>
                <p class="text-xs text-slate-500 mt-2">Route tasks across agents with shared context.</p>
                <button class="mt-4 px-3 h-8 rounded bg-primary/10 border border-primary/20 text-xs font-mono text-primary hover:bg-primary/20">Install</button>
              </div>
              <div class="border border-surface-border bg-[#111111] rounded-lg p-4">
                <p class="text-sm font-semibold text-white">Token Watcher</p>
                <p class="text-xs text-slate-500 mt-2">Live token gauges + alert thresholds.</p>
                <button class="mt-4 px-3 h-8 rounded bg-primary/10 border border-primary/20 text-xs font-mono text-primary hover:bg-primary/20">Install</button>
              </div>
              <div class="border border-surface-border bg-[#111111] rounded-lg p-4">
                <p class="text-sm font-semibold text-white">Prompt Templates</p>
                <p class="text-xs text-slate-500 mt-2">Reusable prompt packs with variables.</p>
                <button class="mt-4 px-3 h-8 rounded bg-primary/10 border border-primary/20 text-xs font-mono text-primary hover:bg-primary/20">Install</button>
              </div>
            </div>
          </section>

          <section id="skills-all" class="hidden space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-white">All Skills</h3>
              <span class="text-[11px] font-mono text-slate-500 uppercase tracking-wide">ClawHub</span>
            </div>
            <div class="border border-dashed border-surface-border rounded-lg p-6 text-sm text-slate-500">
              Full catalog will load from ClawHub once the marketplace API is wired.
            </div>
          </section>
        </div>
      </div>

      <div id="view-setup" class="flex-1 overflow-hidden">
        <section class="h-full overflow-y-auto p-6 lg:p-8 relative">
          <div class="scan-line"></div>

          <div id="agent-config-summary" class="hidden mb-8">
            <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 flex items-center justify-between">
                <div>
                  <p class="text-xs font-mono text-slate-500 uppercase tracking-wide">Agents Live</p>
                  <p id="agents-live-count" class="text-3xl font-bold text-white mt-2">0</p>
                  <p id="agents-live-meta" class="text-[11px] text-slate-500 mt-1">Connected to gateway</p>
                </div>
                <div class="size-12 rounded-lg bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 flex items-center justify-center">
                  <span class="material-symbols-outlined">bolt</span>
                </div>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 flex items-center justify-between">
                <div>
                  <p class="text-xs font-mono text-slate-500 uppercase tracking-wide">New Agent</p>
                  <p class="text-sm text-slate-300 mt-2">Open Agent Config to add another profile or agent.</p>
                </div>
                <button id="agent-config-new" class="px-4 h-10 rounded bg-primary/10 border border-primary/20 text-xs font-mono text-primary hover:bg-primary/20">New Agent</button>
              </div>
            </div>
          </div>

          <div id="agent-config-details" class="max-w-5xl mx-auto space-y-10">
            <div id="step-1" class="flex items-start justify-between gap-6">
              <div>
                <h2 class="text-2xl font-extrabold text-white mt-2">Detect OpenClaw Installation</h2>
                <p id="profile-badge" class="text-[11px] font-mono text-slate-400 mt-2">Profile: default</p>
                <p class="text-slate-400 mt-2 max-w-2xl">Verify OpenClaw is installed, check the version, and locate the default config and skills paths.</p>
              </div>
              <button id="oc-rescan" class="flex items-center gap-2 px-3 py-2 rounded bg-slate-900 border border-slate-800 text-xs font-mono text-slate-300 hover:text-white hover:border-slate-600 transition-colors">
                <span class="material-symbols-outlined text-base">refresh</span>
                Rescan
              </button>
            </div>

            <div class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
              <div class="flex items-center justify-between gap-4">
                <div>
                  <p class="text-sm font-semibold text-white">OpenClaw Profile</p>
                  <p class="text-xs text-slate-500 mt-1">Select the profile that owns your running gateway.</p>
                </div>
                <div class="flex items-center gap-2">
                  <button id="profile-refresh" class="px-3 h-8 rounded bg-slate-900 border border-slate-800 text-[10px] font-mono text-slate-300 hover:text-white">Refresh</button>
                  <button id="profile-new" class="px-3 h-8 rounded bg-primary/10 border border-primary/20 text-[10px] font-mono text-primary hover:bg-primary/20">New Profile</button>
                </div>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Profile</label>
                  <select id="profile-select" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-2 py-2 text-xs text-white font-mono"></select>
                </div>
                <div class="text-[11px] font-mono text-slate-500 space-y-1">
                  <p id="profile-config-path">Config: select profile</p>
                  <p id="profile-workspace-path">Workspace: select profile</p>
                  <p id="profile-skills-path">Skills: select profile</p>
                </div>
              </div>
              <p id="profile-paths-note" class="text-[11px] text-slate-500">Select a profile to load managed paths.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="border border-surface-border bg-surface-dark rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <p class="text-xs font-mono text-slate-500 uppercase">Binary</p>
                  <span id="oc-status-binary" class="text-[10px] font-mono text-emerald-400">FOUND</span>
                </div>
                <p class="text-white font-semibold mt-2">openclaw</p>
                <p id="oc-binary-path" class="text-[11px] font-mono text-slate-500 mt-1">/usr/local/bin/openclaw</p>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <p class="text-xs font-mono text-slate-500 uppercase">Version</p>
                  <span id="oc-status-version" class="text-[10px] font-mono text-emerald-400">OK</span>
                </div>
                <p id="oc-version" class="text-white font-semibold mt-2">v0.14.2</p>
                <p class="text-[11px] font-mono text-slate-500 mt-1">Required: v0.13+</p>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <p class="text-xs font-mono text-slate-500 uppercase">Config</p>
                  <span id="oc-status-config" class="text-[10px] font-mono text-amber-400">PARTIAL</span>
                </div>
                <p id="oc-config" class="text-white font-semibold mt-2">~/.openclaw</p>
                <p class="text-[11px] font-mono text-slate-500 mt-1">Providers: 2 detected</p>
              </div>
            </div>

            <div class="border border-surface-border rounded-lg bg-[#0d0d0d] overflow-hidden">
              <div class="flex items-center justify-between px-4 py-2 bg-surface-dim border-b border-surface-border">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-[16px] text-primary">terminal</span>
                  <p class="text-[11px] font-mono text-slate-400">Detection Log</p>
                </div>
                <button id="oc-log-copy" class="text-[10px] font-mono text-slate-500 hover:text-white">Copy</button>
              </div>
              <div id="oc-log" class="p-4 font-mono text-xs text-slate-300 bg-terminal-bg">
                <p class="text-emerald-400">ok openclaw found</p>
                <p>version: 0.14.2</p>
                <p>config: ~/.openclaw</p>
                <p>skills: ./skills (workspace) + ~/.openclaw/skills</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-white">Gateway Connection</p>
                    <p class="text-xs text-slate-500 mt-1">Connect to the OpenClaw gateway websocket.</p>
                  </div>
                  <span id="gateway-state" class="text-[10px] font-mono text-slate-500">IDLE</span>
                </div>
                <div class="text-[10px] font-mono text-slate-500 space-y-1">
                  <p id="gateway-auth-mode">Auth mode: unknown</p>
                  <p id="gateway-auth-source">Auth source: not detected</p>
                  <p id="gateway-port-source">Gateway port: unknown</p>
                </div>
                <div class="space-y-3">
                  <div>
                    <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Gateway URL</label>
                    <input id="gateway-url" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="ws://127.0.0.1:18789" />
                  </div>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <div>
                      <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Token (optional)</label>
                      <input id="gateway-token" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="shared token" />
                      <div class="mt-2 flex items-center justify-between text-[10px] font-mono text-slate-500">
                        <span id="gateway-token-hint">No profile token detected.</span>
                        <button id="gateway-token-use" class="text-primary hover:text-primary-dim">Use profile token</button>
                      </div>
                      <div class="mt-2 flex items-center justify-between text-[10px] font-mono text-slate-500">
                        <span id="gateway-token-command">Run: openclaw dashboard --no-open</span>
                        <button id="gateway-token-copy" class="text-primary hover:text-primary-dim">Copy</button>
                      </div>
                    </div>
                    <div>
                      <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Password (optional)</label>
                      <input id="gateway-password" type="password" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="pairing password" />
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <button id="gateway-connect" class="px-4 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono hover:bg-primary/20">Connect</button>
                  <button id="gateway-disconnect" class="px-4 h-9 rounded bg-slate-900 border border-slate-800 text-xs font-mono text-slate-300 hover:text-white">Disconnect</button>
                </div>
                <p id="gateway-status" class="text-xs font-mono text-slate-500">Not connected yet.</p>
              </div>

              <div class="border border-surface-border rounded-lg bg-[#0d0d0d] overflow-hidden">
                <div class="flex items-center justify-between px-4 py-2 bg-surface-dim border-b border-surface-border">
                  <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-[16px] text-primary">stream</span>
                    <p class="text-[11px] font-mono text-slate-400">Gateway Stream</p>
                  </div>
                  <button id="gateway-log-clear" class="text-[10px] font-mono text-slate-500 hover:text-white">Clear</button>
                </div>
                <div id="gateway-log" class="p-4 font-mono text-xs text-slate-300 bg-terminal-bg h-[220px] overflow-y-auto"></div>
              </div>
            </div>

            <div class="border border-surface-border bg-surface-dark rounded-lg p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-white">Providers Detected (CLI)</p>
                  <p class="text-xs text-slate-500 mt-1">Log in using the provider CLI or use API keys later.</p>
                </div>
                <button id="providers-viewall" class="text-xs font-mono text-slate-400 hover:text-white">View All</button>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-provider="Claude">
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold text-white">Claude</p>
                    <span class="text-[10px] font-mono text-emerald-400" data-provider-status>CLI FOUND</span>
                  </div>
                <div class="mt-3 flex items-center gap-2 text-[11px] font-mono text-slate-400">
                  <span class="bg-black/40 px-1 rounded">Auth</span>
                  <span data-provider-auth-status>CHECKING</span>
                </div>
                  <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-provider-login>Login via CLI</button>
                </div>
                <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-provider="Gemini">
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold text-white">Gemini</p>
                    <span class="text-[10px] font-mono text-emerald-400" data-provider-status>CLI FOUND</span>
                  </div>
                <div class="mt-3 flex items-center gap-2 text-[11px] font-mono text-slate-400">
                  <span class="bg-black/40 px-1 rounded">Auth</span>
                  <span data-provider-auth-status>CHECKING</span>
                </div>
                  <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-provider-login>Login via CLI</button>
                </div>
                <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-provider="Codex">
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold text-white">Codex</p>
                    <span class="text-[10px] font-mono text-emerald-400" data-provider-status>CLI FOUND</span>
                  </div>
                <div class="mt-3 flex items-center gap-2 text-[11px] font-mono text-slate-400">
                  <span class="bg-black/40 px-1 rounded">Auth</span>
                  <span data-provider-auth-status>CHECKING</span>
                </div>
                  <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-provider-login>Login via CLI</button>
                </div>
              </div>
            </div>

            <div class="border border-surface-border rounded-lg bg-[#0d0d0d] overflow-hidden">
              <div class="flex items-center justify-between px-4 py-2 bg-surface-dim border-b border-surface-border">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-[16px] text-primary">terminal</span>
                  <p class="text-[11px] font-mono text-slate-400">CLI Auth Helper</p>
                </div>
                <button id="auth-helper-copy" class="text-[10px] font-mono text-slate-500 hover:text-white">Copy</button>
              </div>
              <div id="auth-helper" class="p-4 font-mono text-xs text-slate-300 bg-terminal-bg">
                <p class="text-slate-500">Select a provider to see the recommended CLI auth flow.</p>
              </div>
            </div>

            <section id="step-2" class="space-y-4">
              <div>
                <h3 class="text-xl font-bold text-white mt-2">Workspace Paths</h3>
                <p class="text-slate-400 mt-1">Set where OpenClaw should read skills and where Dieah stores workspace data.</p>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Workspace Path</label>
                    <input id="workspace-path" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="/path/to/workspace" />
                  </div>
                  <div>
                    <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Skills Path</label>
                    <input id="skills-path" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="/path/to/skills" />
                  </div>
                </div>
                <div class="flex items-center justify-between">
                  <p id="paths-status" class="text-xs font-mono text-slate-500">Not saved yet.</p>
                  <button id="save-paths" class="px-4 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono hover:bg-primary/20">Save Paths</button>
                </div>
              </div>
            </section>

            <section id="step-3" class="space-y-4">
              <div>
                <h3 class="text-xl font-bold text-white mt-2">Providers and Auth</h3>
                <p class="text-slate-400 mt-1">Choose how each provider authenticates. CLI login is recommended for now.</p>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-auth-provider="Claude">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-semibold text-white">Claude</p>
                      <div class="flex items-center gap-2">
                        <span class="text-[10px] font-mono text-slate-500" data-auth-lock-label>AUTH</span>
                        <button class="text-[10px] font-mono text-slate-500 hover:text-white hidden" data-auth-unlock>Unlock</button>
                      </div>
                    </div>
                    <label class="text-xs font-mono text-slate-500 uppercase tracking-wide mt-3 block">Method</label>
                    <select class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-2 py-2 text-xs text-white font-mono" data-auth-method>
                      <option value="cli">CLI Login</option>
                      <option value="api">API Key</option>
                    </select>
                    <input class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-xs text-white font-mono" placeholder="API key (not stored yet)" data-auth-key />
                    <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-auth-save>Save Auth</button>
                  </div>
                  <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-auth-provider="Gemini">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-semibold text-white">Gemini</p>
                      <div class="flex items-center gap-2">
                        <span class="text-[10px] font-mono text-slate-500" data-auth-lock-label>AUTH</span>
                        <button class="text-[10px] font-mono text-slate-500 hover:text-white hidden" data-auth-unlock>Unlock</button>
                      </div>
                    </div>
                    <label class="text-xs font-mono text-slate-500 uppercase tracking-wide mt-3 block">Method</label>
                    <select class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-2 py-2 text-xs text-white font-mono" data-auth-method>
                      <option value="cli">CLI Login</option>
                      <option value="api">API Key</option>
                    </select>
                    <input class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-xs text-white font-mono" placeholder="API key (not stored yet)" data-auth-key />
                    <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-auth-save>Save Auth</button>
                  </div>
                  <div class="border border-surface-border rounded-lg p-4 bg-[#111111]" data-auth-provider="Codex">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-semibold text-white">Codex</p>
                      <div class="flex items-center gap-2">
                        <span class="text-[10px] font-mono text-slate-500" data-auth-lock-label>AUTH</span>
                        <button class="text-[10px] font-mono text-slate-500 hover:text-white hidden" data-auth-unlock>Unlock</button>
                      </div>
                    </div>
                    <label class="text-xs font-mono text-slate-500 uppercase tracking-wide mt-3 block">Method</label>
                    <select class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-2 py-2 text-xs text-white font-mono" data-auth-method>
                      <option value="cli">CLI Login</option>
                      <option value="api">API Key</option>
                    </select>
                    <input class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-xs text-white font-mono" placeholder="API key (not stored yet)" data-auth-key />
                    <button class="mt-3 w-full py-2 text-xs font-mono rounded bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20" data-auth-save>Save Auth</button>
                  </div>
                </div>
              </div>
            </section>

            <section id="step-4" class="space-y-4">
              <div>
                <h3 class="text-xl font-bold text-white mt-2">Heartbeat and Diagnostics</h3>
                <p class="text-slate-400 mt-1">Gateway heartbeats are disabled. We use activity-based stall detection instead.</p>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-white">Heartbeat</p>
                    <p class="text-xs text-slate-500 mt-1">Disabled by policy to avoid provider issues.</p>
                  </div>
                  <label class="inline-flex items-center gap-2 text-xs font-mono text-slate-400">
                    <input id="heartbeat-enabled" type="checkbox" class="rounded border-surface-border bg-[#0d0d0d]" />
                    DISABLED
                  </label>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Interval (minutes)</label>
                    <input id="heartbeat-interval" type="number" min="1" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" />
                  </div>
                  <div class="flex items-end">
                    <button id="save-heartbeat" class="px-4 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono hover:bg-primary/20">Apply Heartbeat</button>
                  </div>
                </div>
                <p id="heartbeat-status" class="text-xs font-mono text-slate-500">Heartbeat not configured yet.</p>
              </div>
            </section>

            <section id="step-6" class="space-y-4">
              <div class="flex items-center justify-between gap-4">
                <div>
                  <h3 class="text-xl font-bold text-white mt-2">Finish and Agents</h3>
                  <p class="text-slate-400 mt-1">Confirm agents and sessions are visible from the gateway.</p>
                </div>
                <button id="agents-refresh" class="px-4 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono hover:bg-primary/20">Refresh Agents</button>
              </div>
              <div class="border border-surface-border bg-surface-dark rounded-lg p-5 space-y-4">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-semibold text-white">Agents</p>
                  <p id="agents-summary" class="text-xs font-mono text-slate-500">No data yet.</p>
                </div>
                <div id="agents-list" class="grid grid-cols-1 lg:grid-cols-3 gap-4"></div>
              </div>
            </section>
          </div>
        </section>
      </div>

      <div id="view-settings" class="hidden flex-1 overflow-y-auto bg-[#0D0D0D]">
        <div class="flex flex-col max-w-[1000px] mx-auto w-full p-8 pb-24">
          <header class="flex flex-wrap justify-between items-end gap-4 mb-10 border-b border-border-dark pb-6">
            <div class="flex flex-col gap-2">
              <h2 class="text-white text-3xl font-black tracking-tight">Settings</h2>
              <p class="text-slate-400 text-base">System behavior, memory defaults, and workspace preferences.</p>
            </div>
            <button id="settings-reset" class="flex items-center justify-center gap-2 px-4 h-9 rounded bg-slate-900 border border-slate-800 text-slate-300 hover:text-white transition-colors text-xs font-bold uppercase tracking-wide">
              <span class="material-symbols-outlined text-base">restart_alt</span>
              <span>Reset Defaults</span>
            </button>
          </header>

          <section class="mb-12">
            <div class="flex items-center justify-between mb-4 px-1">
              <h3 class="text-white text-lg font-bold">Memory & Context</h3>
              <span class="text-xs font-mono text-slate-500 uppercase tracking-wide">ALWAYS-ON BY DEFAULT</span>
            </div>
            <div class="bg-[#111111] border border-border-dark rounded-lg divide-y divide-slate-800">
              <div class="p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div class="flex flex-col gap-1">
                  <p class="text-sm font-semibold text-white">Enable Memory Engine</p>
                  <p class="text-xs text-slate-500">Inject relevant memories + recent context before every send.</p>
                </div>
                <label class="inline-flex items-center gap-2 text-xs font-mono text-slate-400">
                  <input id="memory-enabled" type="checkbox" class="rounded border-surface-border bg-[#0d0d0d]" />
                  ENABLED
                </label>
              </div>
              <div class="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Memory API URL</label>
                  <input id="memory-url" type="text" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="http://127.0.0.1:8420" />
                </div>
                <div>
                  <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Recent Messages</label>
                  <input id="memory-max-recent" type="number" min="1" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" />
                </div>
              </div>
              <div class="p-4 sm:p-6 flex flex-wrap items-center justify-between gap-3">
                <p id="memory-status" class="text-xs font-mono text-slate-500">Memory engine not connected.</p>
                <div class="flex items-center gap-2">
                  <button id="memory-test" class="px-4 h-9 rounded bg-slate-900 border border-slate-800 text-xs font-mono text-slate-300 hover:text-white">Test</button>
                  <button id="memory-save" class="px-4 h-9 rounded bg-primary/10 text-primary border border-primary/20 text-xs font-mono hover:bg-primary/20">Save Settings</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <div id="view-chat" class="hidden flex-1 flex overflow-hidden bg-[#0D0D0D]">
        <aside class="w-20 h-full flex flex-col items-center py-6 border-r border-border-dark bg-[#0D0D0D] shrink-0">
          <div class="mb-8">
            <div class="size-10 rounded-xl bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/20">
              <span class="material-symbols-outlined text-[24px]">smart_toy</span>
            </div>
          </div>
          <div id="chat-agent-list" class="flex flex-col gap-3 w-full items-center flex-1 overflow-y-auto"></div>
          <button id="chat-agent-add" class="mt-2 w-10 h-10 flex items-center justify-center rounded-full border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 hover:bg-white/5 transition-all" title="Create New Agent">
            <span class="material-symbols-outlined text-[20px]">add</span>
          </button>
          <div class="mt-auto flex flex-col gap-4 w-full items-center">
            <button id="chat-agent-settings" class="text-gray-400 hover:text-white transition-colors size-10 flex items-center justify-center rounded-lg hover:bg-white/5">
              <span class="material-symbols-outlined">settings</span>
            </button>
            <div class="bg-center bg-no-repeat bg-cover rounded-full size-8 ring-2 ring-gray-700"></div>
          </div>
        </aside>

        <div class="flex-1 flex flex-col min-w-0 bg-[#0D0D0D]">
          <header class="h-12 border-b border-border-dark flex items-end px-2 bg-[#0D0D0D] shrink-0">
            <div id="chat-tabs" class="flex items-end gap-1 overflow-x-auto no-scrollbar"></div>
            <button id="chat-tab-add" class="ml-2 p-1.5 text-gray-500 hover:text-white rounded hover:bg-[#161616] transition-colors">
              <span class="material-symbols-outlined text-[20px]">add</span>
            </button>
          </header>

          <div id="chat-feed" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-8 relative"></div>

          <div class="p-3 md:px-4 md:pb-4 bg-[#0D0D0D] shrink-0 z-10">
            <div class="flex flex-col gap-2 mb-2 w-full px-1">
              <div class="flex justify-between items-end gap-4">
                <div class="flex items-center gap-4 flex-1">
                  <div class="flex flex-col flex-1">
                    <div class="flex justify-between items-center text-[10px] uppercase tracking-wider font-medium text-gray-500 mb-2">
                      <span>Context Window</span>
                      <span id="chat-context-count" class="text-primary">0 / -- Tokens</span>
                    </div>
                    <div class="h-1 w-full bg-[#1e1e1e] rounded-full overflow-hidden">
                      <div id="chat-context-bar" class="h-full bg-primary rounded-full w-[0%] shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
                    </div>
                    <div class="flex justify-between items-center text-[9px] uppercase tracking-wider font-medium text-gray-600 mt-2 mb-1">
                      <span>Actual Context</span>
                      <span id="chat-context-actual-count" class="text-emerald-300">0 / -- (+0 mem)</span>
                    </div>
                    <div class="h-0.5 w-full bg-[#141414] rounded-full overflow-hidden">
                      <div id="chat-context-actual-bar" class="h-full bg-emerald-400/80 rounded-full w-[0%] shadow-[0_0_10px_rgba(52,211,153,0.35)]"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="relative w-full group focus-within:ring-1 focus-within:ring-primary/50 rounded-xl transition-all">
              <div class="bg-[#161616] border border-border-dark rounded-xl overflow-hidden shadow-2xl flex flex-col min-h-[100px]">
                <textarea id="chat-input" class="w-full bg-transparent text-sm text-gray-200 placeholder-gray-500 p-4 resize-none focus:ring-0 border-none min-h-[60px] font-mono" placeholder="Message agent..."></textarea>
                <div class="flex items-center justify-between px-3 py-2 bg-[#161616] border-t border-border-dark/50">
                  <div class="flex items-center gap-1">
                    <button class="size-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors" title="Attach File">
                      <span class="material-symbols-outlined text-[20px]">attach_file</span>
                    </button>
                    <button class="size-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors" title="Voice Input">
                      <span class="material-symbols-outlined text-[20px]">mic</span>
                    </button>
                    <div class="h-4 w-px bg-gray-700 mx-1"></div>
                    <button class="size-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors" title="Format Code">
                      <span class="material-symbols-outlined text-[20px]">code</span>
                    </button>
                    <button id="chat-stop" class="size-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors" title="Stop">
                      <span class="material-symbols-outlined text-[20px]">stop_circle</span>
                    </button>
                  </div>
                  <div class="flex items-center gap-3">
                    <span id="chat-status" class="text-[10px] text-gray-600 hidden md:inline-block font-mono">Idle.</span>
                    <button id="chat-send" class="size-8 flex items-center justify-center rounded-lg bg-primary hover:bg-primary-hover text-white shadow-lg shadow-primary/25 transition-all transform active:scale-95">
                      <span class="material-symbols-outlined text-[18px]">arrow_upward</span>
                    </button>
                  </div>
                </div>
              </div>
              <input id="chat-session-key" type="hidden" />
            </div>
          </div>
        </div>

        <div id="chat-agent-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60">
          <div class="w-full max-w-md bg-[#111111] border border-surface-border rounded-xl p-5 shadow-2xl">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-white">Create Agent</p>
              <button id="chat-agent-modal-close" class="text-gray-400 hover:text-white">
                <span class="material-symbols-outlined text-[18px]">close</span>
              </button>
            </div>
            <p class="text-xs text-slate-500 mt-2">Agents are created inside the connected OpenClaw gateway.</p>
            <div class="mt-4 space-y-3">
              <div>
                <label class="text-xs font-mono text-slate-400 uppercase tracking-wide">Agent Name</label>
                <input id="chat-agent-name" type="text" class="mt-2 w-full bg-[#0d0d0d] border border-surface-border rounded px-3 py-2 text-sm text-white font-mono" placeholder="e.g. Asimov Analyst" />
              </div>
              <p id="chat-agent-modal-status" class="text-[11px] font-mono text-slate-500">Ready.</p>
            </div>
            <div class="mt-4 flex items-center justify-end gap-2">
              <button id="chat-agent-modal-cancel" class="px-3 h-9 rounded bg-slate-900 border border-slate-800 text-[11px] font-mono text-slate-300 hover:text-white">Cancel</button>
              <button id="chat-agent-modal-create" class="px-3 h-9 rounded bg-primary/10 border border-primary/20 text-[11px] font-mono text-primary hover:bg-primary/20">Create</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    const invoke = window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke;
    const listen = window.__TAURI__ && window.__TAURI__.event && window.__TAURI__.event.listen;
    let cachedSettings = null;
    let authHelperText = "";
    let gatewayConnected = false;
    let gatewayConnecting = false;
    let gatewayAuto = { url: "", token: "", password: "", authMode: "", source: [] };
    let gatewayDashboardTried = false;
    let currentProfile = "";
    try {
      currentProfile = localStorage.getItem("dieah.profile") || "";
    } catch (error) {
      currentProfile = "";
    }
    let profileManagedPaths = false;
    let profileCreationMode = false;
    const sidebarHiddenKey = "dieah.sidebarHidden";
    let lastGatewayTokenUsed = "";
    const gatewayTokenCachePrefix = "dieah.gatewayToken:";
    let profileApplyTimer = null;
    let profileToastTimer = null;
    const heartbeatPolicyDisabled = true;
    let activeChatRunId = null;
    let lastChatEventAt = 0;
    let stallTimer = null;
    let stallNotified = false;
    let reconnectRequested = false;
    const lastUserMessageByTab = new Map();
    const autoRetryAttempts = new Map();
    const agentConfigCollapsedKey = "dieah.agentConfigCollapsed";
    const dashboardStatsKey = "dieah.dashboardStats";
    let overviewChartData = [];
    let modelCatalog = [];
    const runStartTimes = new Map();

    const statusColors = ["text-emerald-400", "text-amber-400", "text-red-400", "text-slate-400", "text-slate-500"];
    const dotColors = ["bg-emerald-500", "bg-amber-500", "bg-red-500", "bg-slate-600"];
    const memoryDefaults = {
      enabled: true,
      url: "http://127.0.0.1:8420",
      maxRecent: 10,
    };
    const memoryTimeoutMs = 1500;
    const sessionMemoryBoost = new Map();
    const autoSummarySessions = new Set();
    const autoSummaryThreshold = 0.9;

    const setStatus = (el, text, color) => {
      if (!el) return;
      statusColors.forEach((cls) => el.classList.remove(cls));
      el.classList.add(color);
      el.textContent = text;
    };

    const copyText = async (text) => {
      if (!text) return false;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (error) {
        console.warn("Clipboard API failed", error);
      }
      try {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(textarea);
        return ok;
      } catch (error) {
        console.warn("Fallback copy failed", error);
        return false;
      }
    };

    const setPill = (text, color, pulse = false) => {
      const dot = document.getElementById("gateway-pill-dot");
      const label = document.getElementById("gateway-pill-text");
      if (dot) {
        dotColors.forEach((cls) => dot.classList.remove(cls));
        dot.classList.add(color);
        dot.classList.toggle("animate-pulse", pulse);
      }
      if (label) {
        label.textContent = text;
      }
    };

    const setLog = (lines) => {
      const log = document.getElementById("oc-log");
      if (!log) return;
      log.innerHTML = "";
      lines.forEach((line, index) => {
        const p = document.createElement("p");
        if (index === 0) {
          p.classList.add("text-emerald-400");
        }
        p.textContent = line;
        log.appendChild(p);
      });
    };

    const updateProviders = (providers) => {
      const cards = document.querySelectorAll("[data-provider]");
      cards.forEach((card) => {
        const name = card.getAttribute("data-provider");
        const statusEl = card.querySelector("[data-provider-status]");
        const provider = providers.find((p) => p.name === name);
        if (!provider) {
          setStatus(statusEl, "UNKNOWN", "text-amber-400");
          return;
        }
        if (provider.cli_found) {
          setStatus(statusEl, "CLI FOUND", "text-emerald-400");
        } else {
          setStatus(statusEl, "CLI MISSING", "text-red-400");
        }
      });
    };

    const appendGatewayLog = (line, tone = "text-slate-300") => {
      const log = document.getElementById("gateway-log");
      if (!log) return;
      const p = document.createElement("p");
      p.className = tone;
      p.textContent = line;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    };

    const updateGatewayState = (state, detail, color = "text-slate-500", pillColor = "bg-slate-600", pulse = false) => {
      setStatus(document.getElementById("gateway-state"), state, color);
      setPill(`GATEWAY ${state}`, pillColor, pulse);
      const statusEl = document.getElementById("gateway-status");
      if (statusEl) {
        statusEl.textContent = detail || " ";
      }
      const offline = !(state === "READY" || state === "OPEN" || state === "CONNECTING");
      setOfflineBadge(offline);
    };

    const getMemorySettings = () => {
      const settings = cachedSettings || {};
      return {
        enabled: settings.memory_enabled !== undefined ? settings.memory_enabled : memoryDefaults.enabled,
        url: settings.memory_url || memoryDefaults.url,
        maxRecent: settings.memory_max_recent_messages || memoryDefaults.maxRecent,
      };
    };

    const updateMemoryStatus = (text, tone = "text-slate-500") => {
      const statusEl = document.getElementById("memory-status");
      if (!statusEl) return;
      statusEl.className = `text-xs font-mono ${tone}`;
      statusEl.textContent = text;
    };

    const fetchWithTimeout = async (url, options, timeoutMs = memoryTimeoutMs) => {
      const controller = new AbortController();
      const timer = window.setTimeout(() => controller.abort(), timeoutMs);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        return response;
      } finally {
        window.clearTimeout(timer);
      }
    };

    const testMemoryConnection = async () => {
      const { url } = getMemorySettings();
      if (!url) {
        updateMemoryStatus("Memory URL missing.", "text-amber-400");
        return;
      }
      updateMemoryStatus("Testing memory service...", "text-slate-400");
      try {
        const response = await fetchWithTimeout(`${url}/health`, { method: "GET" }, 1000);
        if (!response.ok) {
          updateMemoryStatus("Memory service error.", "text-red-400");
          return;
        }
        const text = await response.text();
        updateMemoryStatus(text.trim() === "ok" ? "Memory service online." : "Memory service reachable.", "text-emerald-400");
      } catch (error) {
        updateMemoryStatus("Memory service unreachable.", "text-red-400");
      }
    };

    const saveMemorySettings = async () => {
      if (!invoke) return;
      const enabledInput = document.getElementById("memory-enabled");
      const urlInput = document.getElementById("memory-url");
      const maxRecentInput = document.getElementById("memory-max-recent");
      const enabled = enabledInput ? enabledInput.checked : memoryDefaults.enabled;
      const url = urlInput ? urlInput.value.trim() : memoryDefaults.url;
      const maxRecent = maxRecentInput ? Number(maxRecentInput.value) : memoryDefaults.maxRecent;
      const nextSettings = cachedSettings || {};
      nextSettings.memory_enabled = enabled;
      nextSettings.memory_url = url || memoryDefaults.url;
      nextSettings.memory_max_recent_messages = Number.isFinite(maxRecent) && maxRecent > 0 ? maxRecent : memoryDefaults.maxRecent;
      try {
        cachedSettings = await invoke("save_settings", { settings: nextSettings });
        updateMemoryStatus("Memory settings saved.", "text-emerald-400");
      } catch (error) {
        updateMemoryStatus("Failed to save memory settings.", "text-red-400");
      }
    };

    const resetMemoryDefaults = async () => {
      const enabledInput = document.getElementById("memory-enabled");
      const urlInput = document.getElementById("memory-url");
      const maxRecentInput = document.getElementById("memory-max-recent");
      if (enabledInput) enabledInput.checked = memoryDefaults.enabled;
      if (urlInput) urlInput.value = memoryDefaults.url;
      if (maxRecentInput) maxRecentInput.value = memoryDefaults.maxRecent;
      await saveMemorySettings();
    };

    const getActiveTopicId = () => {
      return activeTabId || "main";
    };

    const retrieveMemoryContext = async (query) => {
      const { enabled, url, maxRecent } = getMemorySettings();
      if (!enabled || !url) return "";
      try {
        const response = await fetchWithTimeout(
          `${url}/retrieve`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query,
              agent_id: selectedAgentId || undefined,
              topic_id: getActiveTopicId(),
              max_recent_messages: maxRecent,
            }),
          },
          memoryTimeoutMs
        );
        if (!response.ok) return "";
        const data = await response.json();
        return data && data.formatted_context ? data.formatted_context : "";
      } catch (error) {
        return "";
      }
    };

    const appendMemoryMessage = async (role, content) => {
      const { enabled, url } = getMemorySettings();
      if (!enabled || !url || !content) return;
      try {
        await fetchWithTimeout(
          `${url}/messages`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              agent_id: selectedAgentId || "default",
              topic_id: getActiveTopicId(),
              role,
              content,
            }),
          },
          memoryTimeoutMs
        );
      } catch (error) {
        console.warn("Memory append failed", error);
      }
    };

    const appendSummaryNote = (summaryText) => {
      const feed = document.getElementById("chat-feed");
      if (!feed) return;
      const wrapper = document.createElement("div");
      wrapper.className = "border border-primary/20 bg-primary/5 rounded-lg p-4 max-w-4xl mx-auto";
      const header = document.createElement("div");
      header.className = "flex items-center justify-between mb-2";
      const title = document.createElement("span");
      title.className = "text-xs font-mono uppercase tracking-wider text-primary";
      title.textContent = "Auto-summary @90%";
      const time = document.createElement("span");
      time.className = "text-[10px] font-mono text-slate-500";
      time.textContent = formatTime(Date.now());
      header.appendChild(title);
      header.appendChild(time);
      const body = document.createElement("pre");
      body.className = "text-xs text-slate-300 font-mono whitespace-pre-wrap";
      body.textContent = summaryText || "Summary unavailable.";
      wrapper.appendChild(header);
      wrapper.appendChild(body);
      feed.appendChild(wrapper);
      feed.scrollTop = feed.scrollHeight;
    };

    const maybeTriggerAutoSummary = async (sessionKey) => {
      const { enabled } = getMemorySettings();
      if (!enabled) return;
      if (autoSummarySessions.has(sessionKey)) return;
      const limit = agentContextLimits.get(selectedAgentId) || currentContextLimit || 8000;
      if (!limit) return;
      const base = sessionTokenCounts.get(sessionKey) || 0;
      const boost = sessionMemoryBoost.get(sessionKey) || 0;
      const actual = base + boost;
      if (actual / limit < autoSummaryThreshold) return;
      autoSummarySessions.add(sessionKey);
      const snapshot = await retrieveMemoryContext("Summarize the conversation so far.");
      appendSummaryNote(snapshot || "Summary unavailable. Memory service offline.");
    };

    const startStallWatcher = () => {
      if (stallTimer) return;
      stallTimer = window.setInterval(() => {
        if (!activeChatRunId) return;
        const now = Date.now();
        if (!lastChatEventAt) {
          lastChatEventAt = now;
          return;
        }
        const delta = now - lastChatEventAt;
        if (delta > 20000 && !stallNotified) {
          stallNotified = true;
          setChatStatus("Stalled: no tokens for 20s. You can stop or retry.", "text-amber-400");
        }
      }, 3000);
    };

    const stopStallWatcher = () => {
      if (stallTimer) {
        window.clearInterval(stallTimer);
        stallTimer = null;
      }
      stallNotified = false;
      activeChatRunId = null;
      lastChatEventAt = 0;
    };

    const getProfileKey = () => currentProfile || "default";

    const getCachedGatewayToken = () => {
      if (profileCreationMode) return "";
      const key = `${gatewayTokenCachePrefix}${getProfileKey()}`;
      return localStorage.getItem(key) || "";
    };

    const setCachedGatewayToken = (token) => {
      if (profileCreationMode) return;
      if (!token) return;
      const key = `${gatewayTokenCachePrefix}${getProfileKey()}`;
      localStorage.setItem(key, token);
    };

    const applySidebarHidden = (hidden) => {
      const sidebar = document.getElementById("app-sidebar");
      if (!sidebar) return;
      sidebar.classList.toggle("hidden", hidden);
      localStorage.setItem(sidebarHiddenKey, hidden ? "true" : "false");
      const toggleIcon = document.querySelector("#sidebar-toggle .material-symbols-outlined");
      if (toggleIcon) {
        toggleIcon.textContent = hidden ? "dock_to_right" : "dock_to_left";
      }
      const overviewIcon = document.querySelector("#sidebar-toggle-overview .material-symbols-outlined");
      if (overviewIcon) {
        overviewIcon.textContent = hidden ? "dock_to_right" : "dock_to_left";
      }
    };

    const showToast = (message, tone = "text-slate-300") => {
      const toast = document.getElementById("profile-toast");
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed top-6 right-6 z-40 px-4 py-2 rounded-lg bg-[#111111] border border-surface-border text-xs font-mono shadow-lg ${tone}`;
      toast.classList.remove("hidden");
      if (profileToastTimer) window.clearTimeout(profileToastTimer);
      profileToastTimer = window.setTimeout(() => {
        toast.classList.add("hidden");
      }, 2200);
    };

    const hideToast = () => {
      const toast = document.getElementById("profile-toast");
      if (!toast) return;
      toast.classList.add("hidden");
      if (profileToastTimer) window.clearTimeout(profileToastTimer);
      profileToastTimer = null;
    };

    const showConnToast = (message, tone = "text-amber-300") => {
      const toast = document.getElementById("conn-toast");
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed top-16 right-6 z-40 px-4 py-2 rounded-lg bg-[#111111] border border-surface-border text-xs font-mono shadow-lg ${tone}`;
      toast.classList.remove("hidden");
    };

    const hideConnToast = () => {
      const toast = document.getElementById("conn-toast");
      if (!toast) return;
      toast.classList.add("hidden");
    };

    const setOfflineBadge = (visible) => {
      const badge = document.getElementById("gateway-offline-badge");
      if (!badge) return;
      badge.classList.toggle("hidden", !visible);
    };

    const toggleSidebar = () => {
      const sidebar = document.getElementById("app-sidebar");
      if (!sidebar) return;
      applySidebarHidden(!sidebar.classList.contains("hidden"));
    };

    const getProfileArg = () => {
      if (profileCreationMode) return null;
      if (!currentProfile || currentProfile === "default") return null;
      return currentProfile;
    };

    const applyProfileToCommand = (command) => {
      if (!command || !command.startsWith("openclaw ")) return command;
      const profile = getProfileArg();
      if (!profile) return command;
      return command.replace("openclaw ", `openclaw --profile ${profile} `);
    };

    const applyProfileToCommands = (commands) => {
      if (!Array.isArray(commands)) return commands;
      return commands.map((cmd) => applyProfileToCommand(cmd));
    };

    const setInputManaged = (input, managed) => {
      if (!input) return;
      input.disabled = managed;
      input.classList.toggle("opacity-60", managed);
      input.classList.toggle("cursor-not-allowed", managed);
    };

    const updateTokenCommand = () => {
      const label = document.getElementById("gateway-token-command");
      if (!label) return;
      const profile = getProfileArg();
      const cmd = profile ? `openclaw --profile ${profile} dashboard --no-open` : "openclaw dashboard --no-open";
      label.textContent = `Run: ${cmd}`;
    };

    const loadProfilePaths = async () => {
      if (!invoke) return;
      const profileArg = getProfileArg();
      if (!profileArg) {
        profileManagedPaths = false;
        const configEl = document.getElementById("profile-config-path");
        const workspaceEl = document.getElementById("profile-workspace-path");
        const skillsEl = document.getElementById("profile-skills-path");
        if (configEl) configEl.textContent = profileCreationMode ? "Config: new profile" : "Config: select profile";
        if (workspaceEl) workspaceEl.textContent = profileCreationMode ? "Workspace: set manually" : "Workspace: select profile";
        if (skillsEl) skillsEl.textContent = profileCreationMode ? "Skills: set manually" : "Skills: select profile";
        const noteEl = document.getElementById("profile-paths-note");
        if (noteEl) {
          noteEl.textContent = profileCreationMode
            ? "New profile: set paths manually, then save."
            : "Select a profile to load managed paths.";
        }
        const workspaceInput = document.getElementById("workspace-path");
        const skillsInput = document.getElementById("skills-path");
        const saveButton = document.getElementById("save-paths");
        setInputManaged(workspaceInput, false);
        setInputManaged(skillsInput, false);
        if (saveButton) {
          saveButton.disabled = false;
          saveButton.classList.remove("opacity-60", "cursor-not-allowed");
        }
        const profileBadge = document.getElementById("profile-badge");
        if (profileBadge && !profileCreationMode) {
          profileBadge.textContent = "Profile: none";
        }
        return;
      }
      try {
        const info = await invoke("openclaw_profile_paths", { profile: profileArg });
        const configEl = document.getElementById("profile-config-path");
        const workspaceEl = document.getElementById("profile-workspace-path");
        const skillsEl = document.getElementById("profile-skills-path");
        if (configEl) configEl.textContent = `Config: ${info.config_path || "unknown"}`;
        if (workspaceEl) workspaceEl.textContent = `Workspace: ${info.workspace_path || "unknown"}`;
        if (skillsEl) skillsEl.textContent = `Skills: ${info.skills_path || "unknown"}`;

        const workspaceInput = document.getElementById("workspace-path");
        const skillsInput = document.getElementById("skills-path");
        const saveButton = document.getElementById("save-paths");
        const managed = !!profileArg;
        profileManagedPaths = managed;
        const noteEl = document.getElementById("profile-paths-note");
        if (noteEl) {
          noteEl.textContent = managed
            ? "Paths are managed by the selected profile."
            : "You can edit paths or switch to a profile-managed workspace.";
        }
        setInputManaged(workspaceInput, managed);
        setInputManaged(skillsInput, managed);
        if (saveButton) {
          saveButton.disabled = managed;
          saveButton.classList.toggle("opacity-60", managed);
          saveButton.classList.toggle("cursor-not-allowed", managed);
        }
        if (managed || (workspaceInput && !workspaceInput.value)) {
          if (workspaceInput) workspaceInput.value = info.workspace_path || "";
        }
        if (managed || (skillsInput && !skillsInput.value)) {
          if (skillsInput) skillsInput.value = info.skills_path || "";
        }
      } catch (error) {
        console.warn("Failed to load profile paths", error);
      }
    };

    const applyProfile = async (profile) => {
      profileCreationMode = false;
      currentProfile = profile || "";
      localStorage.setItem("dieah.profile", currentProfile);
      gatewayDashboardTried = false;
      gatewayAuto = { url: "", token: "", password: "", authMode: "", source: [] };
      const tokenInput = document.getElementById("gateway-token");
      const passwordInput = document.getElementById("gateway-password");
      const urlInput = document.getElementById("gateway-url");
      if (tokenInput) tokenInput.value = "";
      if (passwordInput) passwordInput.value = "";
      const profileBadge = document.getElementById("profile-badge");
      if (profileBadge) {
        profileBadge.textContent = `Profile: ${currentProfile || "none"}`;
      }
      const savedUrl = localStorage.getItem("dieah.gatewayUrl");
      if (savedUrl) {
        gatewayAuto.url = savedUrl;
        if (urlInput) urlInput.value = savedUrl;
      }
      const cachedToken = getCachedGatewayToken();
      if (cachedToken && tokenInput) {
        tokenInput.value = cachedToken;
        gatewayAuto.token = cachedToken;
        const tokenHint = document.getElementById("gateway-token-hint");
        if (tokenHint) tokenHint.textContent = "Cached token loaded. Click Connect.";
        const tokenUse = document.getElementById("gateway-token-use");
        if (tokenUse) {
          tokenUse.disabled = false;
          tokenUse.classList.remove("opacity-50", "cursor-not-allowed");
        }
      }
      updateTokenCommand();
      await Promise.allSettled([
        loadProfilePaths(),
        loadModelCatalog(),
        loadAuthStatus(),
        loadGatewayInfo(),
      ]);
      const autoConnect = localStorage.getItem("dieah.gatewayAutoConnect") === "true";
      if (autoConnect && !gatewayConnected && !gatewayConnecting) {
        window.setTimeout(() => {
          connectGateway();
        }, 300);
      }
      hideToast();
    };

    const startNewProfile = async () => {
      profileCreationMode = true;
      currentProfile = "";
      localStorage.removeItem("dieah.profile");
      localStorage.removeItem("dieah.gatewayAutoConnect");
      const profileSelect = document.getElementById("profile-select");
      if (profileSelect) profileSelect.value = "";
      const profileBadge = document.getElementById("profile-badge");
      if (profileBadge) profileBadge.textContent = "Profile: new";
      const tokenInput = document.getElementById("gateway-token");
      const passwordInput = document.getElementById("gateway-password");
      if (tokenInput) tokenInput.value = "";
      if (passwordInput) passwordInput.value = "";
      updateTokenCommand();
      await Promise.allSettled([
        loadProfilePaths(),
        loadModelCatalog(),
        loadAuthStatus(),
        loadGatewayInfo(),
      ]);
      hideToast();
    };

    const scheduleApplyProfile = (profile) => {
      if (profileApplyTimer) {
        window.clearTimeout(profileApplyTimer);
      }
      showToast("Loading profile...");
      profileApplyTimer = window.setTimeout(() => {
        profileApplyTimer = null;
        applyProfile(profile);
      }, 400);
    };

    const loadProfiles = async () => {
      if (!invoke) return;
      try {
        const profiles = await invoke("openclaw_profiles");
        const select = document.getElementById("profile-select");
        if (!select || !Array.isArray(profiles)) return;
        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Select profile…";
        select.appendChild(placeholder);
        profiles.forEach((entry) => {
          const option = document.createElement("option");
          option.value = entry.name;
          option.textContent = entry.is_default ? "default" : entry.name;
          select.appendChild(option);
        });
        if (!currentProfile) {
          const stored = localStorage.getItem("dieah.profile");
          if (stored) currentProfile = stored;
        }
        const names = profiles.map((p) => p.name);
        if (!names.includes(currentProfile)) {
          currentProfile = "";
        }
        select.value = currentProfile;
        await applyProfile(currentProfile);
      } catch (error) {
        console.warn("Failed to load profiles", error);
        await applyProfile(currentProfile);
      }
    };

    const tryDashboardToken = async () => {
      if (!invoke || gatewayDashboardTried) return null;
      gatewayDashboardTried = true;
      appendGatewayLog("fetching dashboard token...", "text-amber-400");
      try {
        const info = await invoke("openclaw_dashboard_token", { profile: getProfileArg() });
        if (!info) return null;
        if (info.url) {
          gatewayAuto.url = gatewayAuto.url || info.url;
          const urlInput = document.getElementById("gateway-url");
          if (urlInput && !urlInput.value) {
            urlInput.value = gatewayAuto.url;
          }
        }
        if (info.token) {
          gatewayAuto.token = info.token;
          appendGatewayLog("dashboard token detected", "text-emerald-400");
          const tokenHint = document.getElementById("gateway-token-hint");
          if (tokenHint) {
            tokenHint.textContent = "Dashboard token detected. Click Use profile token.";
          }
          const tokenUse = document.getElementById("gateway-token-use");
          if (tokenUse) {
            tokenUse.disabled = false;
            tokenUse.classList.remove("opacity-50", "cursor-not-allowed");
          }
        }
        return info;
      } catch (error) {
        appendGatewayLog(`dashboard token error: ${String(error)}`, "text-red-400");
        return null;
      }
    };

    const providerAuthCommands = {
      Claude: [
        "claude setup-token",
        "openclaw models auth setup-token --provider anthropic",
        "openclaw models auth paste-token --provider anthropic",
      ],
      Gemini: [
        "openclaw plugins enable google-gemini-cli-auth",
        "openclaw models auth login --provider google-gemini-cli --set-default",
      ],
      Codex: ["openclaw models auth login --provider openai-codex --set-default"],
    };

    const providerIdMap = {
      Claude: ["anthropic", "claude-cli"],
      Gemini: ["google-gemini-cli", "google", "google-antigravity"],
      Codex: ["openai-codex", "openai"],
    };

    const providerLoginCommand = {
      Claude: "openclaw models auth setup-token --provider anthropic",
      Gemini: "openclaw models auth login --provider google-gemini-cli --set-default",
      Codex: "openclaw models auth login --provider openai-codex --set-default",
    };

    const providerAuthState = {
      Claude: { configured: false, detail: "unknown" },
      Gemini: { configured: false, detail: "unknown" },
      Codex: { configured: false, detail: "unknown" },
    };

    const setAuthHelper = (lines, tone = "text-slate-300") => {
      const helper = document.getElementById("auth-helper");
      if (!helper) return;
      helper.innerHTML = "";
      if (!Array.isArray(lines) || lines.length === 0) {
        const p = document.createElement("p");
        p.className = "text-slate-500";
        p.textContent = "Select a provider to see the recommended CLI auth flow.";
        helper.appendChild(p);
        authHelperText = "";
        return;
      }
      authHelperText = lines.join("\n");
      lines.forEach((line, index) => {
        const p = document.createElement("p");
        p.className = index === 0 ? "text-emerald-400" : tone;
        p.textContent = line;
        helper.appendChild(p);
      });
    };

    const handleProviderLogin = async (provider, button) => {
      const authState = providerAuthState[provider];
      if (authState && authState.configured) {
        setAuthHelper([`${provider} auth already configured (${authState.detail}).`], "text-emerald-400");
        return;
      }
      const commands = applyProfileToCommands(providerAuthCommands[provider]);
      if (!commands) {
        setAuthHelper([`No CLI helper available for ${provider}.`], "text-amber-400");
        return;
      }
      setAuthHelper(commands, "text-slate-300");
      try {
          const command = applyProfileToCommand(providerLoginCommand[provider]);
        if (command) {
          await invoke("openclaw_run_in_terminal", { commands: [command] });
          if (button) {
            const original = button.textContent;
            button.textContent = "LAUNCHED";
            button.disabled = true;
            button.classList.add("opacity-60", "cursor-not-allowed");
            window.setTimeout(() => {
              button.textContent = original;
              button.disabled = false;
              button.classList.remove("opacity-60", "cursor-not-allowed");
            }, 1600);
          }
        }
      } catch (error) {
        appendGatewayLog(`auth launch error: ${String(error)}`, "text-red-400");
      }
    };

    const loadAuthStatus = async () => {
      if (!invoke) return;
      if (!getProfileArg() && !profileCreationMode) {
        Object.keys(providerIdMap).forEach((providerName) => {
          const card = document.querySelector(`[data-provider="${providerName}"]`);
          if (card) {
            const statusEl = card.querySelector("[data-provider-auth-status]");
            if (statusEl) {
              setStatus(statusEl, "SELECT PROFILE", "text-amber-400");
            }
            const loginBtn = card.querySelector("[data-provider-login]");
            if (loginBtn) {
              loginBtn.textContent = "Login via CLI";
              loginBtn.disabled = true;
              loginBtn.classList.add("opacity-60", "cursor-not-allowed");
            }
          }
          const authCard = document.querySelector(`[data-auth-provider="${providerName}"]`);
          if (authCard) {
            const methodSelect = authCard.querySelector("[data-auth-method]");
            const keyInput = authCard.querySelector("[data-auth-key]");
            const saveBtn = authCard.querySelector("[data-auth-save]");
            const lockLabel = authCard.querySelector("[data-auth-lock-label]");
            const unlockBtn = authCard.querySelector("[data-auth-unlock]");
            if (methodSelect) methodSelect.disabled = true;
            if (keyInput) keyInput.disabled = true;
            if (saveBtn) saveBtn.disabled = true;
            authCard.classList.add("opacity-60", "cursor-not-allowed");
            if (lockLabel) lockLabel.textContent = "SELECT PROFILE";
            if (unlockBtn) unlockBtn.classList.add("hidden");
          }
        });
        return;
      }
      if (!getProfileArg() && profileCreationMode) {
        Object.keys(providerIdMap).forEach((providerName) => {
          const card = document.querySelector(`[data-provider="${providerName}"]`);
          if (card) {
            const statusEl = card.querySelector("[data-provider-auth-status]");
            if (statusEl) {
              setStatus(statusEl, "NEW PROFILE", "text-amber-400");
            }
            const loginBtn = card.querySelector("[data-provider-login]");
            if (loginBtn) {
              loginBtn.textContent = "Login via CLI";
              loginBtn.disabled = false;
              loginBtn.classList.remove("opacity-60", "cursor-not-allowed");
            }
          }
          const authCard = document.querySelector(`[data-auth-provider="${providerName}"]`);
          if (authCard) {
            const methodSelect = authCard.querySelector("[data-auth-method]");
            const keyInput = authCard.querySelector("[data-auth-key]");
            const saveBtn = authCard.querySelector("[data-auth-save]");
            const lockLabel = authCard.querySelector("[data-auth-lock-label]");
            const unlockBtn = authCard.querySelector("[data-auth-unlock]");
            if (methodSelect) methodSelect.disabled = false;
            if (keyInput) keyInput.disabled = false;
            if (saveBtn) saveBtn.disabled = false;
            authCard.classList.remove("opacity-60", "cursor-not-allowed");
            if (lockLabel) lockLabel.textContent = "NEW";
            if (unlockBtn) unlockBtn.classList.add("hidden");
          }
        });
        return;
      }
      try {
        const status = await invoke("openclaw_models_status", { profile: getProfileArg() });
        const output = status && status.output ? status.output : status;
        currentDefaultModelKey = output?.resolvedDefault || output?.defaultModel || "";
        if (currentDefaultModelKey && modelContextMap.has(currentDefaultModelKey)) {
          currentContextLimit = modelContextMap.get(currentDefaultModelKey);
        }
        if (selectedAgent) {
          refreshContextLimitForAgent(selectedAgent);
        }
        const providers = output?.auth?.providers || output?.auth?.oauth?.providers || [];
        const map = new Map();
        providers.forEach((entry) => {
          if (entry && entry.provider) {
            map.set(entry.provider, entry);
          }
        });

        Object.keys(providerIdMap).forEach((providerName) => {
          const ids = providerIdMap[providerName];
          let configured = false;
          let detail = "missing";
          ids.forEach((id) => {
            const entry = map.get(id);
            if (entry && entry.effective && entry.effective.kind && entry.effective.kind !== "missing") {
              configured = true;
              detail = entry.effective.kind;
            }
          });
          providerAuthState[providerName] = { configured, detail };
          const card = document.querySelector(`[data-provider="${providerName}"]`);
          if (card) {
            const statusEl = card.querySelector("[data-provider-auth-status]");
            if (statusEl) {
              if (configured) {
                setStatus(statusEl, "AUTH OK", "text-emerald-400");
              } else {
                setStatus(statusEl, "AUTH MISSING", "text-amber-400");
              }
            }
            const loginBtn = card.querySelector("[data-provider-login]");
            if (loginBtn) {
              if (configured) {
                loginBtn.textContent = "Configured";
                loginBtn.disabled = true;
                loginBtn.classList.add("opacity-60", "cursor-not-allowed");
              } else {
                loginBtn.textContent = "Login via CLI";
                loginBtn.disabled = false;
                loginBtn.classList.remove("opacity-60", "cursor-not-allowed");
              }
            }
          }

          const authCard = document.querySelector(`[data-auth-provider="${providerName}"]`);
          if (authCard) {
            const methodSelect = authCard.querySelector("[data-auth-method]");
            const keyInput = authCard.querySelector("[data-auth-key]");
            const saveBtn = authCard.querySelector("[data-auth-save]");
            const lockLabel = authCard.querySelector("[data-auth-lock-label]");
            const unlockBtn = authCard.querySelector("[data-auth-unlock]");
            const setLocked = (locked) => {
              if (methodSelect) methodSelect.disabled = locked;
              if (keyInput) keyInput.disabled = locked;
              if (saveBtn) saveBtn.disabled = locked;
              authCard.classList.toggle("opacity-60", locked);
              authCard.classList.toggle("cursor-not-allowed", locked);
              if (lockLabel) lockLabel.textContent = locked ? "LOCKED" : "AUTH";
              if (unlockBtn) {
                unlockBtn.classList.toggle("hidden", !locked);
              }
            };
            if (configured) {
              setLocked(true);
              if (unlockBtn) {
                unlockBtn.onclick = () => {
                  setLocked(false);
                  unlockBtn.classList.add("hidden");
                  if (lockLabel) lockLabel.textContent = "EDIT";
                };
              }
            } else {
              setLocked(false);
            }
          }
        });
      } catch (error) {
        console.warn("Failed to load auth status", error);
      }
    };

    const updateDetection = (data) => {
      setStatus(
        document.getElementById("oc-status-binary"),
        data.found ? "FOUND" : "MISSING",
        data.found ? "text-emerald-400" : "text-red-400"
      );
      setStatus(
        document.getElementById("oc-status-version"),
        data.version ? "OK" : "UNKNOWN",
        data.version ? "text-emerald-400" : "text-amber-400"
      );
      setStatus(
        document.getElementById("oc-status-config"),
        data.config_dir ? "FOUND" : "MISSING",
        data.config_dir ? "text-emerald-400" : "text-red-400"
      );

      const pathEl = document.getElementById("oc-binary-path");
      if (pathEl) pathEl.textContent = data.path || "not found";

      const versionEl = document.getElementById("oc-version");
      if (versionEl) versionEl.textContent = data.version || "unknown";

      const configEl = document.getElementById("oc-config");
      if (configEl) configEl.textContent = data.config_dir || "not found";

      if (Array.isArray(data.log)) {
        setLog(data.log);
      }

      if (Array.isArray(data.providers)) {
        updateProviders(data.providers);
      }
    };

    const connectGateway = async () => {
      if (!invoke) return;
      const urlInput = document.getElementById("gateway-url");
      const tokenInput = document.getElementById("gateway-token");
      const passwordInput = document.getElementById("gateway-password");
      const url = urlInput ? urlInput.value.trim() : "";
      const token = tokenInput ? tokenInput.value.trim() : "";
      const password = passwordInput ? passwordInput.value.trim() : "";
      const finalUrl = url || gatewayAuto.url;
      const cachedToken = getCachedGatewayToken();
      const finalToken = token || cachedToken || gatewayAuto.token || "";
      const finalPassword = password || "";
      if (!url && !gatewayAuto.url) {
        updateGatewayState("MISSING", "Gateway URL is required.", "text-red-400", "bg-red-500");
        return;
      }
      if (url) {
        localStorage.setItem("dieah.gatewayUrl", url);
      }
      lastGatewayTokenUsed = finalToken;
      gatewayConnecting = true;
      updateGatewayState("CONNECTING", "Connecting to gateway...", "text-amber-400", "bg-amber-500", true);
      appendGatewayLog(`connect -> ${finalUrl}`, "text-amber-400");
      try {
        const hello = await invoke("gateway_connect", {
          options: {
            url: finalUrl,
            token: finalToken || null,
            password: finalPassword || null,
            clientName: "webchat-ui",
            mode: "webchat"
          }
        });
        gatewayConnected = true;
        gatewayConnecting = false;
        updateGatewayState("READY", "Gateway handshake complete.", "text-emerald-400", "bg-emerald-500");
        appendGatewayLog("hello ok", "text-emerald-400");
        if (hello) {
          appendGatewayLog(`protocol: ${hello.protocol ?? "unknown"}`, "text-slate-400");
        }
      } catch (error) {
        gatewayConnected = false;
        gatewayConnecting = false;
        const message = String(error);
        updateGatewayState("ERROR", `Connection failed: ${message}`, "text-red-400", "bg-red-500");
        appendGatewayLog(`error: ${message}`, "text-red-400");
        if (message.includes("token mismatch")) {
          const statusEl = document.getElementById("gateway-status");
          if (statusEl) {
            statusEl.textContent = "Token mismatch. Checking dashboard token...";
          }
          const info = await tryDashboardToken();
          if (info && info.token) {
            updateGatewayState(
              "IDLE",
              "Dashboard token available. Click Use profile token, then Connect.",
              "text-amber-400",
              "bg-amber-500"
            );
            const tokenHint = document.getElementById("gateway-token-hint");
            if (tokenHint) {
              tokenHint.textContent = "Dashboard token detected. Click Use profile token.";
            }
            return;
          }
          if (statusEl) {
            statusEl.textContent = "Token mismatch. Paste the token from OpenClaw Control UI settings.";
          }
        }
      }
    };

    const disconnectGateway = async () => {
      if (!invoke) return;
      try {
        await invoke("gateway_disconnect");
      } catch (error) {
        appendGatewayLog(`disconnect error: ${String(error)}`, "text-red-400");
      }
      gatewayConnected = false;
      gatewayConnecting = false;
      updateGatewayState("IDLE", "Disconnected.", "text-slate-500", "bg-slate-600");
      localStorage.removeItem("dieah.gatewayAutoConnect");
      setAgentConfigCollapsed(false);
    };

    const ensureGatewayConnected = async () => {
      if (gatewayConnected || gatewayConnecting) return gatewayConnected;
      if (!gatewayAuto.url) {
        return false;
      }
      await connectGateway();
      return gatewayConnected;
    };

    const autoReconnectIfNeeded = async () => {
      if (gatewayConnected || gatewayConnecting) {
        reconnectRequested = false;
        hideConnToast();
        return gatewayConnected;
      }
      const urlInput = document.getElementById("gateway-url");
      const url = urlInput ? urlInput.value.trim() : "";
      if (!url && !gatewayAuto.url) {
        showConnToast("Gateway offline. Configure in Agent Config.", "text-amber-300");
        reconnectRequested = false;
        return false;
      }
      reconnectRequested = true;
      showConnToast("Reconnecting to gateway...");
      const ok = await ensureGatewayConnected();
      if (ok) {
        hideConnToast();
        reconnectRequested = false;
      } else {
        scheduleReconnectFailure();
      }
      return ok;
    };

    const scheduleReconnectFailure = () => {
      window.setTimeout(() => {
        if (reconnectRequested && !gatewayConnected && !gatewayConnecting) {
          showConnToast("Reconnect failed. Open Agent Config.", "text-amber-300");
          reconnectRequested = false;
        }
      }, 650);
    };

    const loadGatewayInfo = async () => {
      if (!invoke) return;
      const profileArg = getProfileArg();
      if (!profileArg) {
        const tokenHint = document.getElementById("gateway-token-hint");
        if (tokenHint) {
          tokenHint.textContent = profileCreationMode
            ? "New profile: connect after creating gateway auth."
            : "Select a profile to load gateway auth.";
        }
        const tokenUse = document.getElementById("gateway-token-use");
        if (tokenUse) {
          tokenUse.disabled = true;
          tokenUse.classList.add("opacity-50", "cursor-not-allowed");
        }
        return;
      }
      try {
        const info = await invoke("openclaw_gateway_info", { profile: profileArg });
        if (!info) return;
        gatewayAuto = {
          url: info.url || gatewayAuto.url,
          token: info.token || "",
          password: info.password || "",
          authMode: info.auth_mode || "",
          source: info.source || [],
        };
        const cachedToken = getCachedGatewayToken();
        if (cachedToken && !gatewayAuto.token) {
          gatewayAuto.token = cachedToken;
        }
        const authModeEl = document.getElementById("gateway-auth-mode");
        if (authModeEl) {
          authModeEl.textContent = `Auth mode: ${gatewayAuto.authMode || "token"}`;
        }
        const authSourceEl = document.getElementById("gateway-auth-source");
        if (authSourceEl) {
          const authSource = gatewayAuto.source.find((line) => line.startsWith("auth:"));
          authSourceEl.textContent = `Auth source: ${authSource || "not detected"}`;
        }
        const portSourceEl = document.getElementById("gateway-port-source");
        if (portSourceEl) {
          const portSource = gatewayAuto.source.find((line) => line.startsWith("port:"));
          portSourceEl.textContent = `Gateway port: ${portSource || gatewayAuto.url}`;
        }
        const urlInput = document.getElementById("gateway-url");
        if (urlInput && (!urlInput.value || urlInput.value === "ws://127.0.0.1:18789")) {
          urlInput.value = gatewayAuto.url;
        }
        const tokenHint = document.getElementById("gateway-token-hint");
        const tokenUse = document.getElementById("gateway-token-use");
        if (gatewayAuto.token || gatewayAuto.password) {
          if (tokenHint) {
            tokenHint.textContent = `Profile auth detected (${gatewayAuto.authMode || "token"}). Click Use profile token.`;
          }
          if (tokenUse) {
            tokenUse.disabled = !gatewayAuto.token;
            tokenUse.classList.toggle("opacity-50", !gatewayAuto.token);
            tokenUse.classList.toggle("cursor-not-allowed", !gatewayAuto.token);
          }
          updateGatewayState(
            "IDLE",
            `Profile auth detected (${gatewayAuto.authMode || "token"}). Click Connect.`,
            "text-emerald-400",
            "bg-emerald-500"
          );
        } else {
          if (tokenHint) tokenHint.textContent = "No profile token detected.";
          if (tokenUse) {
            tokenUse.disabled = true;
            tokenUse.classList.add("opacity-50", "cursor-not-allowed");
          }
        }
      } catch (error) {
        console.warn("Failed to load gateway info", error);
      }
    };

    const renderSkills = (report) => {
      const list = document.getElementById("skills-list");
      const summary = document.getElementById("skills-summary");
      if (!list || !summary) return;
      list.innerHTML = "";
      if (!report || !Array.isArray(report.skills)) {
        summary.textContent = "No skills returned.";
        return;
      }
      const skills = report.skills;
      const eligible = skills.filter((s) => s.eligible && !s.disabled && !s.blockedByAllowlist).length;
      const disabled = skills.filter((s) => s.disabled).length;
      const missing = skills.filter((s) => !s.eligible).length;
      summary.textContent = `${eligible} ready · ${missing} missing · ${disabled} disabled`;

      skills.forEach((skill) => {
        const card = document.createElement("div");
        card.className = "border border-surface-border rounded-lg p-4 bg-[#111111] flex flex-col gap-3";
        const header = document.createElement("div");
        header.className = "flex items-center justify-between";
        const name = document.createElement("p");
        name.className = "text-sm font-semibold text-white";
        name.textContent = skill.name || "Unnamed skill";
        const status = document.createElement("span");
        status.className = "text-[10px] font-mono";
        if (skill.blockedByAllowlist) {
          status.textContent = "BLOCKED";
          status.classList.add("text-red-400");
        } else if (skill.disabled) {
          status.textContent = "DISABLED";
          status.classList.add("text-amber-400");
        } else if (skill.eligible) {
          status.textContent = "READY";
          status.classList.add("text-emerald-400");
        } else {
          status.textContent = "MISSING";
          status.classList.add("text-red-400");
        }
        header.appendChild(name);
        header.appendChild(status);

        const desc = document.createElement("p");
        desc.className = "text-xs text-slate-500";
        desc.textContent = skill.description || "No description.";

        const actions = document.createElement("div");
        actions.className = "flex items-center gap-2 flex-wrap";

        if (Array.isArray(skill.install) && skill.install.length > 0) {
          const install = skill.install[0];
          const installBtn = document.createElement("button");
          installBtn.className = "px-3 h-8 rounded bg-primary/10 text-primary border border-primary/20 text-[10px] font-mono hover:bg-primary/20";
          installBtn.textContent = install.label || "Install";
          installBtn.setAttribute("data-skill-install", "true");
          installBtn.setAttribute("data-skill-name", skill.name || "");
          installBtn.setAttribute("data-install-id", install.id || "");
          actions.appendChild(installBtn);
        }

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "px-3 h-8 rounded bg-slate-900 border border-slate-800 text-[10px] font-mono text-slate-300 hover:text-white";
        toggleBtn.textContent = skill.disabled ? "Enable" : "Disable";
        toggleBtn.setAttribute("data-skill-toggle", "true");
        toggleBtn.setAttribute("data-skill-key", skill.skillKey || "");
        toggleBtn.setAttribute("data-skill-enabled", skill.disabled ? "true" : "false");
        actions.appendChild(toggleBtn);

        const missingList = [];
        if (skill.missing && Array.isArray(skill.missing.bins) && skill.missing.bins.length) {
          missingList.push(`bins: ${skill.missing.bins.join(", ")}`);
        }
        if (skill.missing && Array.isArray(skill.missing.env) && skill.missing.env.length) {
          missingList.push(`env: ${skill.missing.env.join(", ")}`);
        }
        if (missingList.length) {
          const missing = document.createElement("p");
          missing.className = "text-[10px] font-mono text-slate-500";
          missing.textContent = `missing ${missingList.join(" · ")}`;
          card.appendChild(header);
          card.appendChild(desc);
          card.appendChild(missing);
          card.appendChild(actions);
        } else {
          card.appendChild(header);
          card.appendChild(desc);
          card.appendChild(actions);
        }

        list.appendChild(card);
      });
    };

    const refreshSkills = async () => {
      if (!invoke) return;
      const summary = document.getElementById("skills-summary");
      if (summary) summary.textContent = "Loading...";
      try {
        const ready = await ensureGatewayConnected();
        if (!ready) {
          if (summary) summary.textContent = "Gateway not connected.";
          return;
        }
        const report = await invoke("gateway_request", { method: "skills.status", params: {} });
        renderSkills(report);
      } catch (error) {
        if (summary) summary.textContent = `Error: ${String(error)}`;
      }
    };

    const renderAgents = (data) => {
      const list = document.getElementById("agents-list");
      const summary = document.getElementById("agents-summary");
      if (!list || !summary) return;
      list.innerHTML = "";
      if (!data || !Array.isArray(data.agents)) {
        summary.textContent = "No agents returned.";
        updateAgentsLiveCount(0);
        return;
      }
      updateAgentsLiveCount(data.agents.length);
      summary.textContent = `default: ${data.defaultId || "unknown"} · scope: ${data.scope || "?"}`;
      data.agents.forEach((agent) => {
        const card = document.createElement("div");
        card.className = "border border-surface-border rounded-lg p-4 bg-[#111111]";
        const name = document.createElement("p");
        name.className = "text-sm font-semibold text-white";
        name.textContent = agent.name || agent.id || "agent";
        const meta = document.createElement("p");
        meta.className = "text-[10px] font-mono text-slate-500 mt-2";
        meta.textContent = agent.id || "unknown-id";
        card.appendChild(name);
        card.appendChild(meta);
        list.appendChild(card);
      });
    };

    const refreshAgents = async () => {
      if (!invoke) return;
      const summary = document.getElementById("agents-summary");
      if (summary) summary.textContent = "Loading...";
      try {
        const ready = await ensureGatewayConnected();
        if (!ready) {
          if (summary) summary.textContent = "Gateway not connected.";
          updateAgentsLiveCount(0);
          return;
        }
        const data = await invoke("gateway_request", { method: "agents.list", params: {} });
        renderAgents(data);
        updateDashboard();
      } catch (error) {
        if (summary) summary.textContent = `Error: ${String(error)}`;
      }
    };

    const updateAgentsLiveCount = (count) => {
      const countEl = document.getElementById("agents-live-count");
      if (countEl) countEl.textContent = Number.isFinite(count) ? count.toString() : "0";
      const metaEl = document.getElementById("agents-live-meta");
      if (metaEl) {
        if (gatewayConnected) {
          metaEl.textContent = currentProfile ? `Connected: ${currentProfile}` : "Connected to gateway";
        } else {
          metaEl.textContent = "Gateway not connected";
        }
      }
    };

    const setAgentConfigCollapsed = (collapsed) => {
      const summary = document.getElementById("agent-config-summary");
      const details = document.getElementById("agent-config-details");
      if (summary) summary.classList.toggle("hidden", !collapsed);
      if (details) details.classList.toggle("hidden", collapsed);
      localStorage.setItem(agentConfigCollapsedKey, collapsed ? "true" : "false");
    };

    const applyAgentConfigCollapsed = () => {
      const wantsCollapsed = localStorage.getItem(agentConfigCollapsedKey) === "true";
      setAgentConfigCollapsed(wantsCollapsed);
    };

    let activeView = "overview";
    let lastChatRunId = null;
    const chatRuns = new Map();
    let cachedAgents = [];
    let selectedAgentId = "";
    let selectedAgent = null;
    let activeTabId = "";
    const tabsByAgent = new Map();
    const defaultAgentKey = "dieah.defaultAgent";

    const setView = (view) => {
      const overviewView = document.getElementById("view-overview");
      const skillsView = document.getElementById("view-skills");
      const setupView = document.getElementById("view-setup");
      const chatView = document.getElementById("view-chat");
      const settingsView = document.getElementById("view-settings");
      const navOverview = document.getElementById("nav-overview");
      const navSkills = document.getElementById("nav-skills");
      const navSetup = document.getElementById("nav-setup");
      const navAgents = document.getElementById("nav-agents");
      const navSettings = document.getElementById("nav-settings");
      const appHeader = document.getElementById("app-header");
      activeView = view;
      if (overviewView) overviewView.classList.toggle("hidden", view !== "overview");
      if (skillsView) skillsView.classList.toggle("hidden", view !== "skills");
      if (setupView) setupView.classList.toggle("hidden", view !== "setup");
      if (chatView) chatView.classList.toggle("hidden", view !== "agents");
      if (settingsView) settingsView.classList.toggle("hidden", view !== "settings");
      if (appHeader) appHeader.classList.toggle("hidden", view === "overview");
      if (navOverview) {
        navOverview.classList.toggle("bg-primary/10", view === "overview");
        navOverview.classList.toggle("text-primary", view === "overview");
        navOverview.classList.toggle("border", view === "overview");
        navOverview.classList.toggle("border-primary/10", view === "overview");
        navOverview.classList.toggle("shadow-glow", view === "overview");
      }
      if (navSetup) {
        navSetup.classList.toggle("bg-primary/10", view === "setup");
        navSetup.classList.toggle("text-primary", view === "setup");
        navSetup.classList.toggle("border", view === "setup");
        navSetup.classList.toggle("border-primary/10", view === "setup");
        navSetup.classList.toggle("shadow-glow", view === "setup");
      }
      if (navSkills) {
        navSkills.classList.toggle("bg-primary/10", view === "skills");
        navSkills.classList.toggle("text-primary", view === "skills");
        navSkills.classList.toggle("border", view === "skills");
        navSkills.classList.toggle("border-primary/10", view === "skills");
        navSkills.classList.toggle("shadow-glow", view === "skills");
      }
      if (navAgents) {
        navAgents.classList.toggle("bg-primary/10", view === "agents");
        navAgents.classList.toggle("text-primary", view === "agents");
        navAgents.classList.toggle("border", view === "agents");
        navAgents.classList.toggle("border-primary/10", view === "agents");
        navAgents.classList.toggle("shadow-glow", view === "agents");
      }
      if (navSettings) {
        navSettings.classList.toggle("bg-primary/10", view === "settings");
        navSettings.classList.toggle("text-primary", view === "settings");
        navSettings.classList.toggle("border", view === "settings");
        navSettings.classList.toggle("border-primary/10", view === "settings");
        navSettings.classList.toggle("shadow-glow", view === "settings");
      }
      const headerView = document.getElementById("header-view");
      if (headerView) {
        if (view === "overview") {
          headerView.textContent = "overview";
        } else if (view === "agents") {
          headerView.textContent = "agents";
        } else if (view === "skills") {
          headerView.textContent = "skills";
        } else if (view === "settings") {
          headerView.textContent = "settings";
        } else {
          headerView.textContent = "openclaw";
        }
      }
      if (view === "setup") {
        applyAgentConfigCollapsed();
      }
    };

    const setChatStatus = (text, tone = "text-slate-500") => {
      const status = document.getElementById("chat-status");
      if (!status) return;
      status.className = `text-[10px] font-mono hidden md:inline-block ${tone}`;
      status.textContent = text;
    };

    const setOverviewLoading = (message, visible = true) => {
      const banner = document.getElementById("overview-loading");
      if (!banner) return;
      if (message) {
        const text = banner.querySelector("span:last-child");
        if (text) text.textContent = message;
      }
      banner.classList.toggle("hidden", !visible);
    };

    const defaultDashboardStats = () => ({
      totalMessages: 0,
      totalTokens: 0,
      totalRuns: 0,
      responseTimes: [],
      daily: {},
      recentConversations: [],
    });

    const loadDashboardStats = () => {
      try {
        const raw = localStorage.getItem(dashboardStatsKey);
        if (!raw) return defaultDashboardStats();
        const parsed = JSON.parse(raw);
        const stats = { ...defaultDashboardStats(), ...parsed };
        if (!stats.daily || typeof stats.daily !== "object") stats.daily = {};
        if (!Array.isArray(stats.responseTimes)) stats.responseTimes = [];
        if (!Array.isArray(stats.recentConversations)) stats.recentConversations = [];
        return stats;
      } catch (error) {
        return defaultDashboardStats();
      }
    };

    const saveDashboardStats = (stats) => {
      try {
        localStorage.setItem(dashboardStatsKey, JSON.stringify(stats));
      } catch (error) {
        console.warn("Failed to save dashboard stats", error);
      }
    };

    const getDateKey = (date) => date.toISOString().slice(0, 10);

    const ensureDailyStats = (stats, key) => {
      if (!stats.daily[key]) {
        stats.daily[key] = { messages: 0, tokens: 0, runs: 0 };
      }
      return stats.daily[key];
    };

    const formatShortDate = (date) =>
      date.toLocaleDateString([], { weekday: "short", day: "2-digit" });

    const formatRelative = (timestamp) => {
      if (!timestamp) return "";
      const delta = Date.now() - timestamp;
      if (delta < 60000) return "just now";
      if (delta < 3600000) return `${Math.floor(delta / 60000)} mins ago`;
      if (delta < 86400000) return `${Math.floor(delta / 3600000)} hours ago`;
      return `${Math.floor(delta / 86400000)} days ago`;
    };

    const recordDashboardMessage = (role, text, meta = {}) => {
      if (!text) return;
      const stats = loadDashboardStats();
      const tokens = estimateTokens(text || "");
      stats.totalMessages += 1;
      stats.totalTokens += tokens;
      const todayKey = getDateKey(new Date());
      const daily = ensureDailyStats(stats, todayKey);
      daily.messages += 1;
      daily.tokens += tokens;

      if (role === "user") {
        const agentId = meta.agentId || selectedAgentId || "agent";
        const agentName = meta.agentName || getAgentName(selectedAgent) || agentId;
        const modelLabel = meta.modelLabel || resolveAgentModelKey(selectedAgent) || currentDefaultModelKey || "model";
        const title = text.split(/\n/)[0].trim() || "New conversation";
        const convoId = `${agentId}:${activeTabId || "main"}`;
        const next = stats.recentConversations.filter((item) => item.id !== convoId);
        next.unshift({
          id: convoId,
          title: title.length > 48 ? `${title.slice(0, 48)}…` : title,
          agent: agentName,
          model: modelLabel,
          timestamp: Date.now(),
        });
        stats.recentConversations = next.slice(0, 6);
      }

      saveDashboardStats(stats);
      updateDashboard();
    };

    const recordDashboardRun = (durationMs) => {
      const stats = loadDashboardStats();
      stats.totalRuns += 1;
      const todayKey = getDateKey(new Date());
      const daily = ensureDailyStats(stats, todayKey);
      daily.runs += 1;
      if (Number.isFinite(durationMs) && durationMs > 0) {
        stats.responseTimes.push(durationMs);
        if (stats.responseTimes.length > 50) {
          stats.responseTimes = stats.responseTimes.slice(-50);
        }
      }
      saveDashboardStats(stats);
      updateDashboard();
    };

    const renderOverviewChart = (stats) => {
      const line = document.getElementById("overview-chart-line");
      const area = document.getElementById("overview-chart-area");
      const labels = Array.from({ length: 7 }, (_, idx) =>
        document.getElementById(`overview-chart-label-${idx}`)
      );
      if (!line || !area) return;
      const days = [];
      for (let i = 6; i >= 0; i -= 1) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date);
      }
      overviewChartData = days.map((date) => {
        const key = getDateKey(date);
        const daily = stats.daily[key] || { messages: 0, tokens: 0 };
        return {
          key,
          label: formatShortDate(date),
          tokens: daily.tokens || 0,
          messages: daily.messages || 0,
        };
      });
      overviewChartData.forEach((point, idx) => {
        const label = labels[idx];
        if (label) label.textContent = point.label;
      });

      const maxTokens = Math.max(1, ...overviewChartData.map((p) => p.tokens));
      const plotTop = 40;
      const plotBottom = 260;
      const width = 1000;
      const step = overviewChartData.length > 1 ? width / (overviewChartData.length - 1) : width;
      const points = overviewChartData.map((point, idx) => {
        const x = idx * step;
        const y = plotBottom - (point.tokens / maxTokens) * (plotBottom - plotTop);
        return { x, y };
      });
      if (!points.length) return;
      const linePath = points.map((pt, idx) => `${idx === 0 ? "M" : "L"}${pt.x},${pt.y}`).join(" ");
      const areaPath = `${linePath} L${points[points.length - 1].x},300 L0,300 Z`;
      line.setAttribute("d", linePath);
      area.setAttribute("d", areaPath);
      line.dataset.maxTokens = String(maxTokens);
    };

    const renderRecentConversations = (stats) => {
      const list = document.getElementById("overview-conversations");
      const empty = document.getElementById("overview-conversations-empty");
      if (!list || !empty) return;
      list.innerHTML = "";
      if (!stats.recentConversations.length) {
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");
      stats.recentConversations.forEach((item) => {
        const row = document.createElement("div");
        row.className = "p-4 hover:bg-gray-50 dark:hover:bg-surface-hover transition-colors flex items-center gap-4 group cursor-pointer";
        const iconWrap = document.createElement("div");
        iconWrap.className = "w-10 h-10 rounded-lg bg-primary/10 text-primary flex items-center justify-center flex-shrink-0 border border-primary/20";
        iconWrap.innerHTML = '<span class="material-symbols-outlined text-[20px]">chat_bubble</span>';
        const body = document.createElement("div");
        body.className = "flex-1 min-w-0";
        const title = document.createElement("h4");
        title.className = "text-sm font-medium text-gray-900 dark:text-white truncate group-hover:text-primary transition-colors";
        title.textContent = item.title || "Conversation";
        const meta = document.createElement("div");
        meta.className = "flex items-center gap-2 mt-1";
        meta.innerHTML = `<span class=\"text-xs text-gray-500 dark:text-gray-400\">${item.agent || "Agent"}</span><span class=\"w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600\"></span><span class=\"text-xs text-gray-400 dark:text-gray-500\">${formatRelative(item.timestamp)}</span>`;
        body.appendChild(title);
        body.appendChild(meta);
        const model = document.createElement("div");
        model.className = "text-[10px] font-mono font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-background-dark border border-gray-200 dark:border-border-subtle px-2 py-1 rounded";
        model.textContent = item.model || "model";
        row.appendChild(iconWrap);
        row.appendChild(body);
        row.appendChild(model);
        list.appendChild(row);
      });
    };

    const normalizeModelLabel = (model) => {
      if (!model) return "model";
      if (typeof model === "string") return model;
      return model.label || model.displayName || model.name || model.key || "model";
    };

    const deriveModelStatus = (model) => {
      const raw = (model && (model.status || model.health || model.state)) || "connected";
      const status = String(raw).toLowerCase();
      if (status.includes("error") || status.includes("fail")) return "error";
      if (status.includes("warn") || status.includes("latency")) return "warn";
      return "ok";
    };

    const renderConnectedModels = () => {
      const list = document.getElementById("overview-models-list");
      const empty = document.getElementById("overview-models-empty");
      if (!list || !empty) return;
      list.innerHTML = "";
      if (!modelCatalog.length) {
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");
      modelCatalog.forEach((model) => {
        const label = normalizeModelLabel(model);
        const state = deriveModelStatus(model);
        const row = document.createElement("div");
        row.className = "flex items-center justify-between p-3 rounded-lg border border-gray-100 dark:border-border-subtle bg-gray-50 dark:bg-surface-hover/50 hover:bg-white dark:hover:bg-surface-hover transition-colors group";
        const left = document.createElement("div");
        left.className = "flex items-center gap-3";
        const dot = document.createElement("div");
        dot.className = `w-2 h-2 rounded-full ${state === "error" ? "bg-red-500" : state === "warn" ? "bg-yellow-500" : "bg-green-500"}`;
        left.appendChild(dot);
        const name = document.createElement("span");
        name.className = "font-medium text-gray-700 dark:text-gray-200 text-sm";
        name.textContent = label;
        left.appendChild(name);
        const tag = document.createElement("span");
        tag.className = `text-[10px] font-bold tracking-wide px-2 py-0.5 rounded uppercase ${state === "error" ? "text-red-400 bg-red-500/10 border border-red-500/20" : state === "warn" ? "text-yellow-400 bg-yellow-500/10 border border-yellow-500/20" : "text-green-400 bg-green-500/10 border border-green-500/20"}`;
        tag.textContent = state === "error" ? "Error" : state === "warn" ? "Latency" : "Connected";
        row.appendChild(left);
        row.appendChild(tag);
        list.appendChild(row);
      });
    };

    const updateDashboard = () => {
      const stats = loadDashboardStats();
      const totalMessages = document.getElementById("dash-total-messages");
      const totalMessagesMeta = document.getElementById("dash-total-messages-meta");
      if (totalMessages) totalMessages.textContent = stats.totalMessages.toLocaleString();
      if (totalMessagesMeta) {
        totalMessagesMeta.textContent = stats.totalMessages ? "Tracking local sessions." : "No activity yet.";
      }

      const activeAgents = document.getElementById("dash-active-agents");
      const activeAgentsMeta = document.getElementById("dash-active-agents-meta");
      const agentCount = cachedAgents.length || 0;
      if (activeAgents) activeAgents.textContent = agentCount ? agentCount.toString() : "—";
      if (activeAgentsMeta) {
        activeAgentsMeta.textContent = gatewayConnected
          ? `${agentCount} active`
          : "Gateway not connected.";
      }

      const avgResponse = document.getElementById("dash-avg-response");
      const avgResponseMeta = document.getElementById("dash-avg-response-meta");
      if (stats.responseTimes.length) {
        const avgMs = stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length;
        if (avgResponse) avgResponse.textContent = `${(avgMs / 1000).toFixed(1)}s`;
        if (avgResponseMeta) avgResponseMeta.textContent = "Across recent runs.";
      } else {
        if (avgResponse) avgResponse.textContent = "—";
        if (avgResponseMeta) avgResponseMeta.textContent = "No responses yet.";
      }

      const tokensToday = document.getElementById("dash-tokens-today");
      const tokensTodayMeta = document.getElementById("dash-tokens-today-meta");
      const todayKey = getDateKey(new Date());
      const today = stats.daily[todayKey] || { tokens: 0, runs: 0 };
      if (tokensToday) tokensToday.textContent = today.tokens ? today.tokens.toLocaleString() : "—";
      if (tokensTodayMeta) {
        tokensTodayMeta.textContent = today.tokens ? `${today.runs || 0} runs today.` : "No tokens yet.";
      }

      renderOverviewChart(stats);
      renderRecentConversations(stats);
      renderConnectedModels();
    };

    const setSkillsFilter = (filter) => {
      const curated = document.getElementById("skills-curated");
      const all = document.getElementById("skills-all");
      const btnCurated = document.getElementById("skills-filter-curated");
      const btnAll = document.getElementById("skills-filter-all");
      const showAll = filter === "all";
      if (curated) curated.classList.toggle("hidden", showAll);
      if (all) all.classList.toggle("hidden", !showAll);
      if (btnCurated) {
        btnCurated.classList.toggle("bg-primary/10", !showAll);
        btnCurated.classList.toggle("text-primary", !showAll);
        btnCurated.classList.toggle("border-primary/20", !showAll);
        btnCurated.classList.toggle("bg-slate-900", showAll);
        btnCurated.classList.toggle("border-slate-800", showAll);
        btnCurated.classList.toggle("text-slate-300", showAll);
      }
      if (btnAll) {
        btnAll.classList.toggle("bg-primary/10", showAll);
        btnAll.classList.toggle("text-primary", showAll);
        btnAll.classList.toggle("border-primary/20", showAll);
        btnAll.classList.toggle("bg-slate-900", !showAll);
        btnAll.classList.toggle("border-slate-800", !showAll);
        btnAll.classList.toggle("text-slate-300", !showAll);
      }
      localStorage.setItem("dieah.skillsFilter", filter);
    };

    const applySkillsFilter = () => {
      const stored = localStorage.getItem("dieah.skillsFilter") || "curated";
      setSkillsFilter(stored);
    };

    const initOverviewChart = () => {
      const chart = document.getElementById("overview-chart");
      const hit = document.getElementById("overview-chart-hit");
      const marker = document.getElementById("overview-chart-marker");
      const dot = document.getElementById("overview-chart-dot");
      const tooltip = document.getElementById("overview-chart-tooltip");
      if (!chart || !hit || !marker || !dot || !tooltip) return;
      const showPoint = (clientX) => {
        if (!overviewChartData.length) return;
        const rect = hit.getBoundingClientRect();
        const clampedX = Math.min(Math.max(clientX - rect.left, 0), rect.width);
        const index = Math.min(
          overviewChartData.length - 1,
          Math.max(0, Math.round((clampedX / rect.width) * (overviewChartData.length - 1)))
        );
        const point = overviewChartData[index];
        const maxTokens = Number(chart.querySelector("#overview-chart-line")?.dataset?.maxTokens || 1);
        const plotTop = 40;
        const plotBottom = rect.height;
        const ratio = point.tokens / (maxTokens || 1);
        const y = plotBottom - ratio * (plotBottom - plotTop);
        marker.style.left = `${clampedX}px`;
        dot.style.left = `${Math.max(0, Math.min(rect.width - 8, clampedX - 4))}px`;
        dot.style.top = `${Math.max(0, Math.min(rect.height - 8, y - 4))}px`;
        tooltip.innerHTML = `
          <div class="text-[10px] font-mono text-slate-400 uppercase tracking-wide">${point.label}</div>
          <div class="text-sm font-semibold text-white mt-1">${point.tokens.toLocaleString()} tokens</div>
          <div class="text-[11px] text-slate-400 mt-1">${point.messages.toLocaleString()} messages</div>
        `;
        tooltip.classList.remove("hidden");
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = clampedX + 12;
        if (left + tooltipRect.width > rect.width) {
          left = clampedX - tooltipRect.width - 12;
        }
        left = Math.max(8, Math.min(left, rect.width - tooltipRect.width - 8));
        let top = y - 24;
        top = Math.max(8, Math.min(top, rect.height - tooltipRect.height - 8));
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        marker.classList.remove("hidden");
        dot.classList.remove("hidden");
      };
      const hidePoint = () => {
        marker.classList.add("hidden");
        dot.classList.add("hidden");
        tooltip.classList.add("hidden");
      };
      hit.addEventListener("mousemove", (event) => {
        showPoint(event.clientX);
      });
      hit.addEventListener("mouseleave", hidePoint);
      hit.addEventListener("touchmove", (event) => {
        if (!event.touches.length) return;
        showPoint(event.touches[0].clientX);
      });
      hit.addEventListener("touchend", hidePoint);
    };

    const formatTime = (ts) => {
      if (!ts) return "";
      const date = new Date(ts);
      if (Number.isNaN(date.getTime())) return "";
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    };

    const extractMessageParts = (message) => {
      const parts = { text: "", thinking: "" };
      if (!message) return parts;
      if (typeof message === "string") {
        parts.text = message;
        return parts;
      }
      if (message.text && typeof message.text === "string") {
        parts.text = message.text;
      }
      if (message.thinking && typeof message.thinking === "string") {
        parts.thinking = message.thinking;
      }
      if (message.reasoning && typeof message.reasoning === "string") {
        parts.thinking = parts.thinking
          ? `${parts.thinking}\n${message.reasoning}`
          : message.reasoning;
      }
      if (Array.isArray(message.content)) {
        const textParts = [];
        const thinkingParts = [];
        message.content.forEach((item) => {
          if (!item || typeof item.text !== "string") return;
          if (item.type === "text") {
            textParts.push(item.text);
          } else if (item.type === "thinking" || item.type === "reasoning") {
            thinkingParts.push(item.text);
          }
        });
        if (textParts.length) parts.text = textParts.join("");
        if (thinkingParts.length) parts.thinking = thinkingParts.join("");
      }
      return parts;
    };

    const parseToolErrorPayload = (text) => {
      if (!text) return "";
      const trimmed = text.trim();
      if (!trimmed.startsWith("{") || !trimmed.endsWith("}")) return "";
      try {
        const payload = JSON.parse(trimmed);
        if (payload && typeof payload.error === "string") {
          return payload.error;
        }
      } catch (error) {
        return "";
      }
      return "";
    };

    let currentContextLimit = 8000;
    const agentContextLimits = new Map();
    const modelContextMap = new Map();
    let currentDefaultModelKey = "";
    const sessionTokenCounts = new Map();
    const runTokenCounts = new Map();
    const tabKeyPrefix = "dieah.chatTabs:";
    const tabActivePrefix = "dieah.chatActiveTab:";
    const agentCacheKey = "dieah.cachedAgents";
    const agentPalette = [
      { ring: "ring-purple-500", text: "text-purple-400", border: "border-purple-500/50", shadow: "shadow-purple-500/10" },
      { ring: "ring-cyan-400", text: "text-cyan-300", border: "border-cyan-400/40", shadow: "shadow-cyan-500/10" },
      { ring: "ring-orange-400", text: "text-orange-300", border: "border-orange-400/40", shadow: "shadow-orange-500/10" },
      { ring: "ring-emerald-400", text: "text-emerald-300", border: "border-emerald-400/40", shadow: "shadow-emerald-500/10" },
      { ring: "ring-sky-400", text: "text-sky-300", border: "border-sky-400/40", shadow: "shadow-sky-500/10" },
      { ring: "ring-pink-400", text: "text-pink-300", border: "border-pink-400/40", shadow: "shadow-pink-500/10" },
    ];

    const estimateTokens = (text) => {
      if (!text) return 0;
      const trimmed = text.trim();
      if (!trimmed) return 0;
      return Math.max(1, Math.ceil(trimmed.length / 4));
    };

    const updateContextBar = (sessionKey) => {
      const count = sessionTokenCounts.get(sessionKey) || 0;
      const limit = agentContextLimits.get(selectedAgentId) || currentContextLimit || 8000;
      const countEl = document.getElementById("chat-context-count");
      const bar = document.getElementById("chat-context-bar");
      const actualCountEl = document.getElementById("chat-context-actual-count");
      const actualBar = document.getElementById("chat-context-actual-bar");
      const boost = sessionMemoryBoost.get(sessionKey) || 0;
      const actual = count + boost;
      if (countEl) {
        countEl.textContent = `${count.toLocaleString()} / ${limit.toLocaleString()} Tokens`;
      }
      if (bar) {
        const pct = limit ? Math.min(100, Math.round((count / limit) * 100)) : 0;
        bar.style.width = `${pct}%`;
      }
      if (actualCountEl) {
        actualCountEl.textContent = `${actual.toLocaleString()} / ${limit.toLocaleString()} (+${boost.toLocaleString()} mem)`;
      }
      if (actualBar) {
        const pct = limit ? Math.min(100, Math.round((actual / limit) * 100)) : 0;
        actualBar.style.width = `${pct}%`;
      }
      void maybeTriggerAutoSummary(sessionKey);
    };

    const addTokens = (sessionKey, delta) => {
      if (!sessionKey) return;
      const current = sessionTokenCounts.get(sessionKey) || 0;
      const next = Math.max(0, current + delta);
      sessionTokenCounts.set(sessionKey, next);
      if (sessionKey === getChatSessionKey()) {
        updateContextBar(sessionKey);
      }
    };

    const getAgentId = (agent) => {
      if (!agent) return "";
      return agent.id || agent.key || agent.name || agent.identityName || "";
    };

    const getAgentName = (agent) => {
      if (!agent) return "Agent";
      return (
        agent.identityName ||
        agent.identity?.name ||
        agent.identity?.displayName ||
        agent.name ||
        agent.displayName ||
        agent.id ||
        "Agent"
      );
    };

    const getAgentAvatarText = (agent) => {
      if (!agent) return "AI";
      if (agent.identityEmoji) return agent.identityEmoji;
      if (agent.identity && agent.identity.emoji) return agent.identity.emoji;
      return getAgentInitials(getAgentName(agent));
    };

    const getAgentInitials = (name) => {
      const trimmed = (name || "").trim();
      if (!trimmed) return "AI";
      const parts = trimmed.split(/\s+/).slice(0, 2);
      return parts.map((part) => part[0]?.toUpperCase() || "").join("");
    };

    const resolveAgentModelKey = (agent) => {
      if (!agent) return currentDefaultModelKey || "";
      return (
        agent.model ||
        agent.modelKey ||
        agent.modelName ||
        agent.defaultModel ||
        agent.resolvedDefault ||
        currentDefaultModelKey ||
        ""
      );
    };

    const refreshContextLimitForAgent = (agent) => {
      if (!agent) return;
      const agentId = getAgentId(agent);
      let limit = 0;
      if (typeof agent.contextWindow === "number") {
        limit = agent.contextWindow;
      }
      const modelKey = resolveAgentModelKey(agent);
      if (!limit && modelKey && modelContextMap.has(modelKey)) {
        limit = modelContextMap.get(modelKey);
      }
      if (!limit && currentDefaultModelKey && modelContextMap.has(currentDefaultModelKey)) {
        limit = modelContextMap.get(currentDefaultModelKey);
      }
      if (!limit) limit = 8000;
      agentContextLimits.set(agentId, limit);
      currentContextLimit = limit;
      updateContextBar(getChatSessionKey());
    };

    const loadModelCatalog = async () => {
      if (!invoke) return;
      if (!getProfileArg()) {
        modelContextMap.clear();
        currentContextLimit = 8000;
        return;
      }
      try {
        const status = await invoke("openclaw_models_list", { profile: getProfileArg() });
        const output = status && status.output ? status.output : status;
        const models = Array.isArray(output?.models) ? output.models : [];
        modelContextMap.clear();
        modelCatalog = models;
        models.forEach((model) => {
          if (model && model.key && typeof model.contextWindow === "number") {
            modelContextMap.set(model.key, model.contextWindow);
          }
        });
        if (!currentDefaultModelKey && models[0] && models[0].key) {
          currentDefaultModelKey = models[0].key;
        }
        if (currentDefaultModelKey && modelContextMap.has(currentDefaultModelKey)) {
          currentContextLimit = modelContextMap.get(currentDefaultModelKey);
        }
        renderConnectedModels();
        updateDashboard();
      } catch (error) {
        console.warn("Failed to load model catalog", error);
      }
    };

    const loadAgentMetadata = async () => {
      if (!invoke) return new Map();
      if (!getProfileArg()) return new Map();
      try {
        const status = await invoke("openclaw_agents_list", { profile: getProfileArg() });
        const output = status && status.output ? status.output : status;
        const agents = Array.isArray(output) ? output : Array.isArray(output?.agents) ? output.agents : [];
        const map = new Map();
        agents.forEach((agent) => {
          if (agent && agent.id) {
            map.set(agent.id, agent);
          }
        });
        return map;
      } catch (error) {
        console.warn("Failed to load agent metadata", error);
        return new Map();
      }
    };

    const getAgentPalette = (agentId) => {
      if (!agentId) return agentPalette[0];
      const idx = cachedAgents.findIndex((agent) => getAgentId(agent) === agentId);
      const index = idx >= 0 ? idx : 0;
      return agentPalette[index % agentPalette.length];
    };

    const getChatSessionKey = () => {
      if (!selectedAgentId) return "main";
      const tabs = getTabsForAgent(selectedAgentId);
      const activeId = activeTabId || localStorage.getItem(`${tabActivePrefix}${selectedAgentId}`) || "";
      const tab = tabs.find((item) => item.id === activeId) || tabs[0];
      return tab ? tab.sessionKey : "main";
    };

    const buildAgentSessionKey = (agentId) => {
      const cleaned = (agentId || "").trim();
      if (!cleaned) return "main";
      return `agent:${cleaned}:main`;
    };

    const getDefaultAgent = () => localStorage.getItem(defaultAgentKey) || "";

    const setDefaultAgent = (agentId) => {
      const trimmed = (agentId || "").trim();
      if (!trimmed) return false;
      localStorage.setItem(defaultAgentKey, trimmed);
      return true;
    };

    const loadCachedAgents = () => {
      if (cachedAgents.length) return;
      try {
        const raw = localStorage.getItem(agentCacheKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            cachedAgents = parsed;
            updateAgentsLiveCount(cachedAgents.length);
          }
        }
      } catch (error) {
        console.warn("Failed to load cached agents", error);
      }
    };

    const saveCachedAgents = () => {
      try {
        localStorage.setItem(agentCacheKey, JSON.stringify(cachedAgents));
      } catch (error) {
        console.warn("Failed to save cached agents", error);
      }
    };

    const getTabsForAgent = (agentId) => {
      const key = `${tabKeyPrefix}${agentId}`;
      if (!agentId) return [];
      if (tabsByAgent.has(agentId)) {
        return tabsByAgent.get(agentId);
      }
      let tabs = [];
      try {
        const raw = localStorage.getItem(key);
        if (raw) tabs = JSON.parse(raw);
      } catch (error) {
        console.warn("Failed to parse tabs", error);
      }
      if (!Array.isArray(tabs) || tabs.length === 0) {
        tabs = [
          {
            id: "general",
            title: "General Chat",
            icon: "chat_bubble",
            sessionKey: buildAgentSessionKey(agentId),
            createdAt: Date.now(),
          },
        ];
      }
      tabsByAgent.set(agentId, tabs);
      return tabs;
    };

    const saveTabsForAgent = (agentId, tabs) => {
      if (!agentId) return;
      const key = `${tabKeyPrefix}${agentId}`;
      tabsByAgent.set(agentId, tabs);
      try {
        localStorage.setItem(key, JSON.stringify(tabs));
      } catch (error) {
        console.warn("Failed to store tabs", error);
      }
    };

    const createNewTab = (agentId) => {
      const token = window.crypto && window.crypto.randomUUID
        ? window.crypto.randomUUID().slice(0, 8)
        : `${Date.now()}`.slice(-8);
      return {
        id: `tab-${token}`,
        title: "New Topic",
        icon: "chat_bubble",
        sessionKey: `agent:${agentId}:${token}`,
        createdAt: Date.now(),
      };
    };

    const generateSessionKey = (agentId) => {
      const token = window.crypto && window.crypto.randomUUID
        ? window.crypto.randomUUID().slice(0, 8)
        : `${Date.now()}`.slice(-8);
      return `agent:${agentId}:${token}`;
    };

    const resetSessionForActiveTab = () => {
      if (!selectedAgentId || !activeTabId) return null;
      const tabs = getTabsForAgent(selectedAgentId);
      const tab = tabs.find((item) => item.id === activeTabId);
      if (!tab) return null;
      const newKey = generateSessionKey(selectedAgentId);
      tab.sessionKey = newKey;
      saveTabsForAgent(selectedAgentId, tabs);
      const input = document.getElementById("chat-session-key");
      if (input) input.value = newKey;
      sessionTokenCounts.set(newKey, 0);
      sessionMemoryBoost.set(newKey, 0);
      autoSummarySessions.delete(newKey);
      updateContextBar(newKey);
      return newKey;
    };

    const renderTabs = () => {
      const tabsRoot = document.getElementById("chat-tabs");
      if (!tabsRoot) return;
      tabsRoot.innerHTML = "";
      if (!selectedAgentId) return;
      const tabs = getTabsForAgent(selectedAgentId);
      const activeId = activeTabId || localStorage.getItem(`${tabActivePrefix}${selectedAgentId}`) || tabs[0]?.id;
      tabs.forEach((tab) => {
        const isActive = tab.id === activeId;
        const tabEl = document.createElement("div");
        tabEl.className = isActive
          ? "group relative flex items-center gap-2 px-4 py-2.5 bg-surface-dark border-t-2 border-t-primary text-white rounded-t min-w-[160px] max-w-[220px] cursor-default"
          : "group relative flex items-center gap-2 px-4 py-2.5 text-gray-400 border-t-2 border-transparent hover:bg-[#161616]/50 rounded-t min-w-[160px] max-w-[220px] cursor-pointer transition-colors border-r border-r-border-dark/50";
        tabEl.setAttribute("data-tab-id", tab.id);
        const icon = document.createElement("span");
        icon.className = `material-symbols-outlined ${isActive ? "text-primary" : "text-gray-500"} text-[18px]`;
        icon.textContent = tab.icon || "chat_bubble";
        const title = document.createElement("span");
        title.className = "text-xs font-medium truncate flex-1";
        title.textContent = tab.title || "Untitled";
        const close = document.createElement("button");
        close.className = "opacity-0 group-hover:opacity-100 text-gray-400 hover:text-white transition-opacity";
        close.innerHTML = '<span class="material-symbols-outlined text-[16px]">close</span>';
        close.addEventListener("click", (event) => {
          event.stopPropagation();
          removeTab(tab.id);
        });
        tabEl.appendChild(icon);
        tabEl.appendChild(title);
        tabEl.appendChild(close);
        if (!isActive) {
          tabEl.addEventListener("click", () => {
            setActiveTab(tab.id);
          });
        }
        tabsRoot.appendChild(tabEl);
      });
    };

    const setActiveTab = (tabId, options = {}) => {
      if (!selectedAgentId) return;
      const tabs = getTabsForAgent(selectedAgentId);
      const tab = tabs.find((item) => item.id === tabId) || tabs[0];
      if (!tab) return;
      activeTabId = tab.id;
      localStorage.setItem(`${tabActivePrefix}${selectedAgentId}`, tab.id);
      const input = document.getElementById("chat-session-key");
      if (input) input.value = tab.sessionKey;
      updateChatPlaceholder();
      if (!sessionTokenCounts.has(tab.sessionKey)) {
        sessionTokenCounts.set(tab.sessionKey, 0);
      }
      if (!sessionMemoryBoost.has(tab.sessionKey)) {
        sessionMemoryBoost.set(tab.sessionKey, 0);
      }
      updateContextBar(tab.sessionKey);
      renderTabs();
      if (!options.skipHistory) {
        loadChatHistory();
      }
    };

    const removeTab = (tabId) => {
      if (!selectedAgentId) return;
      const tabs = getTabsForAgent(selectedAgentId).filter((tab) => tab.id !== tabId);
      if (!tabs.length) {
        const fresh = createNewTab(selectedAgentId);
        tabs.push(fresh);
      }
      saveTabsForAgent(selectedAgentId, tabs);
      const nextActive = tabs[0].id;
      setActiveTab(nextActive);
    };

    const updateChatPlaceholder = () => {
      const input = document.getElementById("chat-input");
      if (!input) return;
      const name = selectedAgent ? getAgentName(selectedAgent) : "agent";
      input.placeholder = `Message ${name}...`;
    };

    const renderAgentRail = () => {
      const list = document.getElementById("chat-agent-list");
      if (!list) return;
      list.innerHTML = "";
      if (!cachedAgents.length) {
        const empty = document.createElement("div");
        empty.className = "text-[10px] font-mono text-gray-600 mt-4 text-center px-2";
        empty.textContent = "No agents yet.";
        list.appendChild(empty);
        return;
      }
      cachedAgents.forEach((agent) => {
        const agentId = getAgentId(agent);
        const name = getAgentName(agent);
        const palette = getAgentPalette(agentId);
        const wrapper = document.createElement("button");
        wrapper.type = "button";
        wrapper.className = `group relative cursor-pointer w-14 h-14 flex items-center justify-center rounded-xl transition-all duration-200 ${
          agentId === selectedAgentId ? "bg-white/10" : "hover:bg-white/5"
        }`;
        wrapper.setAttribute("data-agent-id", agentId);
        const tooltip = document.createElement("div");
        tooltip.className =
          "absolute left-16 top-1/2 -translate-y-1/2 bg-surface-dark border border-border-dark px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl text-gray-200";
        tooltip.textContent = agentId === selectedAgentId ? `${name} (Active)` : name;
        const avatar = document.createElement("div");
        avatar.className = `size-10 rounded-full ring-1 ${palette.ring} bg-[#1a1a1a] flex items-center justify-center text-[12px] font-semibold text-white/80`;
        avatar.textContent = getAgentAvatarText(agent);
        wrapper.appendChild(tooltip);
        wrapper.appendChild(avatar);
        wrapper.addEventListener("click", () => {
          selectAgent(agentId);
        });
        list.appendChild(wrapper);
      });
    };

    const selectAgent = (agentId, options = {}) => {
      if (!agentId) return;
      const agent = cachedAgents.find((item) => getAgentId(item) === agentId) || { id: agentId, name: agentId };
      selectedAgentId = agentId;
      selectedAgent = agent;
      localStorage.setItem("dieah.chatAgent", agentId);
      refreshContextLimitForAgent(agent);
      renderAgentRail();
      const tabs = getTabsForAgent(agentId);
      activeTabId = localStorage.getItem(`${tabActivePrefix}${agentId}`) || tabs[0]?.id;
      renderTabs();
      updateChatPlaceholder();
      setActiveTab(activeTabId, { skipHistory: options.skipHistory });
    };

    const loadChatAgents = async () => {
      loadCachedAgents();
      renderAgentRail();
      if (!modelContextMap.size) {
        await loadModelCatalog();
      }
      if (!invoke) return;
      const ready = await ensureGatewayConnected();
      if (!ready) {
        setChatStatus("Gateway not connected.", "text-amber-400");
        updateAgentsLiveCount(0);
        setOverviewLoading("Loading existing models... (gateway offline)", true);
        return;
      }
      try {
        const [data, metadataMap] = await Promise.all([
          invoke("gateway_request", { method: "agents.list", params: {} }),
          loadAgentMetadata(),
        ]);
        cachedAgents = Array.isArray(data?.agents) ? data.agents : [];
        updateAgentsLiveCount(cachedAgents.length);
        if (metadataMap && metadataMap.size) {
          cachedAgents = cachedAgents.map((agent) => {
            const agentId = getAgentId(agent);
            const extra = metadataMap.get(agentId);
            if (!extra) return agent;
            return { ...agent, ...extra };
          });
        }
        saveCachedAgents();
        renderAgentRail();
        const stored = localStorage.getItem("dieah.chatAgent") || getDefaultAgent() || data?.defaultId || "";
        const fallback = stored || getAgentId(cachedAgents[0]) || "";
        if (fallback) {
          selectAgent(fallback);
        }
        setOverviewLoading("", false);
        setChatStatus("Agents loaded.", "text-emerald-400");
        updateDashboard();
      } catch (error) {
        setChatStatus(`Agents load failed: ${String(error)}`, "text-red-400");
      }
    };

    const openAgentModal = () => {
      const modal = document.getElementById("chat-agent-modal");
      const status = document.getElementById("chat-agent-modal-status");
      const input = document.getElementById("chat-agent-name");
      if (status) status.textContent = "Ready.";
      if (input) input.value = "";
      if (modal) modal.classList.remove("hidden");
      if (input) input.focus();
    };

    const closeAgentModal = () => {
      const modal = document.getElementById("chat-agent-modal");
      if (modal) modal.classList.add("hidden");
    };

    const createAgent = async () => {
      if (!invoke) return;
      const input = document.getElementById("chat-agent-name");
      const status = document.getElementById("chat-agent-modal-status");
      const name = input ? input.value.trim() : "";
      if (!name) {
        if (status) status.textContent = "Agent name is required.";
        return;
      }
      const ready = await ensureGatewayConnected();
      if (!ready) {
        if (status) status.textContent = "Gateway not connected.";
        return;
      }
      if (status) status.textContent = "Creating agent...";
      try {
        await invoke("gateway_request", {
          method: "agents.create",
          params: { name },
        });
        appendGatewayLog(`agents.create ok: ${name}`, "text-emerald-400");
        closeAgentModal();
        await loadChatAgents();
        const match = cachedAgents.find((agent) => getAgentName(agent) === name || getAgentId(agent) === name);
        if (match) {
          selectAgent(getAgentId(match) || name);
        }
      } catch (error) {
        if (status) status.textContent = `Create failed: ${String(error)}`;
        appendGatewayLog(`agents.create error: ${String(error)}`, "text-red-400");
      }
    };

    const autoLaunchDefaultAgent = async () => {
      const agentId = getDefaultAgent();
      if (!agentId) return;
      setView("agents");
      if (!cachedAgents.length) {
        await loadChatAgents();
      }
      if (agentId && agentId !== selectedAgentId) {
        selectAgent(agentId);
        return;
      }
      if (selectedAgentId) {
        await loadChatHistory();
      }
    };

    const ensureChatReady = async () => {
      if (!selectedAgentId) {
        setChatStatus("Select an agent to chat.", "text-amber-400");
        return null;
      }
      const sessionKey = getChatSessionKey();
      if (!sessionKey) {
        setChatStatus("Session key required.", "text-amber-400");
        return null;
      }
      const ready = await ensureGatewayConnected();
      if (!ready) {
        setChatStatus("Gateway not connected.", "text-amber-400");
        return null;
      }
      return sessionKey;
    };

    const createCodeBlock = (code, label = "snippet") => {
      const wrapper = document.createElement("div");
      wrapper.className = "rounded-lg border border-border-dark bg-[#0a0a0a] overflow-hidden shadow-lg mt-2 font-mono";
      const header = document.createElement("div");
      header.className = "flex items-center justify-between px-4 py-2 bg-[#161616] border-b border-border-dark";
      const dots = document.createElement("div");
      dots.className = "flex gap-1.5";
      ["bg-red-500/20", "bg-yellow-500/20", "bg-green-500/20"].forEach((cls) => {
        const dot = document.createElement("div");
        dot.className = `size-2.5 rounded-full ${cls}`;
        dots.appendChild(dot);
      });
      const name = document.createElement("span");
      name.className = "text-[10px] text-gray-500";
      name.textContent = label;
      const copyBtn = document.createElement("button");
      copyBtn.className = "flex items-center gap-1.5 text-gray-500 hover:text-white transition-colors";
      copyBtn.innerHTML = '<span class="material-symbols-outlined text-[14px]">content_copy</span><span class="text-[10px] font-medium">Copy</span>';
      copyBtn.addEventListener("click", async () => {
        const ok = await copyText(code);
        const labelEl = copyBtn.querySelector("span.text-[10px]");
        if (labelEl) labelEl.textContent = ok ? "Copied" : "Copy";
        window.setTimeout(() => {
          const resetEl = copyBtn.querySelector("span.text-[10px]");
          if (resetEl) resetEl.textContent = "Copy";
        }, 1200);
      });
      header.appendChild(dots);
      header.appendChild(name);
      header.appendChild(copyBtn);
      const body = document.createElement("div");
      body.className = "p-4 overflow-x-auto";
      const pre = document.createElement("pre");
      const codeEl = document.createElement("code");
      codeEl.className = "text-xs md:text-sm font-mono leading-relaxed text-gray-300";
      codeEl.textContent = code;
      pre.appendChild(codeEl);
      body.appendChild(pre);
      wrapper.appendChild(header);
      wrapper.appendChild(body);
      return wrapper;
    };

    const renderAssistantContent = (text, container) => {
      const blocks = String(text || "").split("```");
      blocks.forEach((block, index) => {
        if (index % 2 === 0) {
          const trimmed = block.trim();
          if (!trimmed) return;
          const paragraphs = trimmed.split(/\n\n+/);
          paragraphs.forEach((para) => {
            const p = document.createElement("p");
            p.className = "text-gray-300 text-sm leading-relaxed font-sans whitespace-pre-wrap";
            p.textContent = para;
            container.appendChild(p);
          });
        } else {
          const lines = block.split("\n");
          let label = "snippet";
          const firstLine = lines[0] ? lines[0].trim() : "";
          if (firstLine && !firstLine.includes(" ") && firstLine.length <= 12) {
            label = firstLine;
            lines.shift();
          }
          const code = lines.join("\n").trim();
          if (!code) return;
          container.appendChild(createCodeBlock(code, label));
        }
      });
    };

    const renderThinkingBlock = (text, container, open = true) => {
      if (!text || !container) return null;
      const details = document.createElement("details");
      details.className = "border border-border-dark rounded-lg bg-[#0d0d0d] text-gray-300";
      details.open = open;
      const summary = document.createElement("summary");
      summary.className = "cursor-pointer list-none px-3 py-2 text-[11px] uppercase tracking-wider font-mono text-gray-500 flex items-center justify-between";
      summary.innerHTML = '<span>Thinking</span><span class="material-symbols-outlined text-[16px]">expand_more</span>';
      const body = document.createElement("div");
      body.className = "px-3 pb-3 text-xs font-mono text-gray-400 whitespace-pre-wrap";
      body.textContent = text;
      details.appendChild(summary);
      details.appendChild(body);
      container.appendChild(details);
      return { details, body };
    };

    const maybeInsertDateDivider = (feed, timestamp) => {
      if (!feed || feed.querySelector("[data-date-divider]")) return;
      const ts = timestamp || Date.now();
      const date = new Date(ts);
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();
      const label = isToday
        ? `Today, ${formatTime(ts)}`
        : `${date.toLocaleDateString([], { month: "short", day: "numeric" })}, ${formatTime(ts)}`;
      const wrapper = document.createElement("div");
      wrapper.className = "flex justify-center pt-6";
      wrapper.setAttribute("data-date-divider", "true");
      const pill = document.createElement("span");
      pill.className = "text-[11px] font-medium text-gray-500 bg-[#161616] px-3 py-1 rounded-full border border-border-dark";
      pill.textContent = label;
      wrapper.appendChild(pill);
      feed.appendChild(wrapper);
    };

    const appendChatMessage = ({ role, text, thinking, timestamp, runId, state, sessionKey, skipTokens }) => {
      const feed = document.getElementById("chat-feed");
      if (!feed) return null;
      if (!feed.children.length) {
        maybeInsertDateDivider(feed, timestamp);
      }
      const messageWrapper = document.createElement("div");
      const palette = getAgentPalette(selectedAgentId);
      if (role === "user") {
        messageWrapper.className = "flex flex-col items-end gap-1";
        const row = document.createElement("div");
        row.className = "flex items-end gap-3 max-w-[85%] lg:max-w-[70%] flex-row";
        const bubbleWrap = document.createElement("div");
        bubbleWrap.className = "flex flex-col gap-1 items-end w-full";
        const bubble = document.createElement("div");
        bubble.className =
          "bg-[#6366F1]/10 border border-[#6366F1]/20 text-white rounded-l-xl rounded-tr-xl rounded-br-sm px-5 py-3 shadow-sm backdrop-blur-sm";
        const textEl = document.createElement("p");
        textEl.className = "text-sm font-mono leading-relaxed text-gray-100 whitespace-pre-wrap";
        textEl.textContent = text || "";
        bubble.appendChild(textEl);
        const meta = document.createElement("span");
        meta.className = "text-[10px] text-gray-500 mr-1 font-mono";
        meta.textContent = formatTime(timestamp || Date.now());
        bubbleWrap.appendChild(bubble);
        bubbleWrap.appendChild(meta);
        const avatar = document.createElement("div");
        avatar.className = "bg-center bg-no-repeat bg-cover rounded-full size-8 shrink-0 ring-1 ring-[#6366F1]/50 shadow-lg shadow-[#6366F1]/20 flex items-center justify-center text-[10px] font-semibold text-white/70";
        avatar.textContent = "You";
        row.appendChild(bubbleWrap);
        row.appendChild(avatar);
        messageWrapper.appendChild(row);
        feed.appendChild(messageWrapper);
        feed.scrollTop = feed.scrollHeight;
        if (sessionKey && !skipTokens) addTokens(sessionKey, estimateTokens(text || ""));
        return textEl;
      }

      messageWrapper.className = "flex flex-col items-start gap-1";
      const row = document.createElement("div");
      row.className = "flex items-start gap-4 max-w-[90%] lg:max-w-[80%]";
      const avatar = document.createElement("div");
      avatar.className = `bg-center bg-no-repeat bg-cover rounded-full size-10 shrink-0 border ${palette.border} mt-1 shadow-lg ${palette.shadow} flex items-center justify-center text-[10px] font-semibold text-white/80`;
      avatar.textContent = getAgentAvatarText(selectedAgent);
      const contentWrap = document.createElement("div");
      contentWrap.className = "flex flex-col gap-2 min-w-0 flex-1";
      const header = document.createElement("div");
      header.className = "flex items-center gap-2";
      const name = document.createElement("span");
      name.className = `text-sm font-bold font-mono ${palette.text}`;
      name.textContent = getAgentName(selectedAgent);
      const time = document.createElement("span");
      time.className = "text-[10px] text-gray-600 font-mono";
      time.textContent = formatTime(timestamp || Date.now());
      header.appendChild(name);
      header.appendChild(time);
      const bodyWrap = document.createElement("div");
      bodyWrap.className = `pl-4 border-l-2 ${palette.border}`;
      const content = document.createElement("div");
      content.className = "text-gray-300 text-sm leading-relaxed font-sans";
      const textContainer = document.createElement("div");
      textContainer.className = "space-y-3";
      let thinkingBlock = null;
      if (thinking) {
        thinkingBlock = renderThinkingBlock(thinking, content, state === "delta");
      }
      if (state === "error") {
        const errorText = document.createElement("p");
        errorText.className = "text-red-300 text-sm font-mono whitespace-pre-wrap";
        errorText.textContent = text || "Error";
        textContainer.appendChild(errorText);
      } else {
        renderAssistantContent(text, textContainer);
      }
      content.appendChild(textContainer);
      bodyWrap.appendChild(content);
      contentWrap.appendChild(header);
      contentWrap.appendChild(bodyWrap);
      row.appendChild(avatar);
      row.appendChild(contentWrap);
      messageWrapper.appendChild(row);
      feed.appendChild(messageWrapper);
      feed.scrollTop = feed.scrollHeight;
      if (runId) {
        chatRuns.set(runId, {
          textEl: textContainer,
          thinkingEl: thinkingBlock ? thinkingBlock.body : null,
          thinkingDetails: thinkingBlock ? thinkingBlock.details : null,
          streamEl: null,
          wrapper: messageWrapper,
          role: "assistant",
          lastRenderAt: 0,
          pendingTimer: null,
          pendingText: "",
          pendingThinking: "",
        });
      } else if (sessionKey && !skipTokens) {
        addTokens(sessionKey, estimateTokens(text || ""));
      }
      return content;
    };

    const updateChatRun = (runId, parts, sessionKey, state) => {
      const text = parts && parts.text ? parts.text : "";
      const thinking = parts && parts.thinking ? parts.thinking : "";
      const entry = chatRuns.get(runId);
      if (entry && entry.textEl) {
        const now = Date.now();
        if (state === "delta") {
          if (entry.lastRenderAt && now - entry.lastRenderAt < 60) {
            entry.pendingText = text;
            entry.pendingThinking = thinking;
            if (!entry.pendingTimer) {
              entry.pendingTimer = window.setTimeout(() => {
                entry.pendingTimer = null;
                updateChatRun(runId, { text: entry.pendingText, thinking: entry.pendingThinking }, sessionKey, "delta");
              }, 60);
            }
            return;
          }
        }

        entry.lastRenderAt = now;
        if (thinking) {
          if (entry.thinkingEl) {
            entry.thinkingEl.textContent = thinking;
          } else {
            const container = entry.textEl.parentElement;
            const block = renderThinkingBlock(thinking, container, state === "delta");
            if (block) {
              entry.thinkingEl = block.body;
              entry.thinkingDetails = block.details;
              if (entry.textEl && entry.textEl.parentElement) {
                entry.textEl.parentElement.insertBefore(block.details, entry.textEl);
              }
            }
          }
        }

        if (state === "delta") {
          if (!entry.streamEl) {
            entry.streamEl = document.createElement("pre");
            entry.streamEl.className = "text-xs font-mono text-slate-300 whitespace-pre-wrap";
            entry.textEl.innerHTML = "";
            entry.textEl.appendChild(entry.streamEl);
          }
          entry.streamEl.textContent = text;
        } else {
          if (entry.pendingTimer) {
            window.clearTimeout(entry.pendingTimer);
            entry.pendingTimer = null;
          }
          entry.textEl.innerHTML = "";
          renderAssistantContent(text, entry.textEl);
          entry.streamEl = null;
          if (entry.thinkingDetails) {
            entry.thinkingDetails.open = false;
          }
        }

        const feed = document.getElementById("chat-feed");
        if (feed) feed.scrollTop = feed.scrollHeight;
      } else {
        appendChatMessage({ role: "assistant", text, thinking, timestamp: Date.now(), runId, sessionKey, state });
      }
      const tokens = estimateTokens(text || "");
      const prev = runTokenCounts.get(runId) || 0;
      runTokenCounts.set(runId, tokens);
      if (sessionKey) addTokens(sessionKey, tokens - prev);
    };

    const loadChatHistory = async () => {
      if (!invoke) return;
      const sessionKey = await ensureChatReady();
      if (!sessionKey) return;
      setChatStatus("Loading history...", "text-slate-400");
      try {
        const response = await invoke("chat_history", {
          payload: { sessionKey, limit: 200 },
        });
        const feed = document.getElementById("chat-feed");
        if (feed) feed.innerHTML = "";
        chatRuns.clear();
        runTokenCounts.clear();
        lastChatRunId = null;
        let tokenTotal = 0;
        const messages = response?.messages || [];
        messages.forEach((msg) => {
          const parts = extractMessageParts(msg);
          appendChatMessage({
            role: msg.role || "assistant",
            text: parts.text,
            thinking: parts.thinking,
            timestamp: msg.timestamp,
            sessionKey,
            skipTokens: true,
          });
          tokenTotal += estimateTokens(parts.text || "");
        });
      sessionTokenCounts.set(sessionKey, tokenTotal);
      sessionMemoryBoost.set(sessionKey, 0);
      autoSummarySessions.delete(sessionKey);
      updateContextBar(sessionKey);
      setChatStatus(`Loaded ${messages.length} messages.`, "text-emerald-400");
      } catch (error) {
        setChatStatus(`History error: ${String(error)}`, "text-red-400");
      }
    };

    const maybeRenameTab = (message) => {
      if (!selectedAgentId || !activeTabId) return;
      const tabs = getTabsForAgent(selectedAgentId);
      const tab = tabs.find((item) => item.id === activeTabId);
      if (!tab || tab.title !== "New Topic") return;
      const snippet = message.split(/\n/)[0].trim();
      if (!snippet) return;
      tab.title = snippet.length > 28 ? `${snippet.slice(0, 28)}…` : snippet;
      saveTabsForAgent(selectedAgentId, tabs);
      renderTabs();
    };

    const sendMessageWithMemory = async (message, options = {}) => {
      if (!invoke) return false;
      const sessionKey = await ensureChatReady();
      if (!sessionKey) return false;
      const trimmed = message.trim();
      if (!trimmed) return false;
      const appendUser = options.appendUser !== false;
      const allowAutoRetry = options.allowAutoRetry !== false;
      if (appendUser) {
        if (activeTabId) {
          lastUserMessageByTab.set(activeTabId, trimmed);
          autoRetryAttempts.set(activeTabId, 0);
        }
        appendChatMessage({ role: "user", text: trimmed, timestamp: Date.now(), sessionKey });
        maybeRenameTab(trimmed);
        recordDashboardMessage("user", trimmed, {
          agentId: selectedAgentId,
          agentName: getAgentName(selectedAgent),
          modelLabel: resolveAgentModelKey(selectedAgent) || currentDefaultModelKey,
        });
      }
      const memorySettings = getMemorySettings();
      if (memorySettings.enabled) {
        setChatStatus("Fetching memory...", "text-slate-400");
      } else {
        setChatStatus("Sending...", "text-slate-400");
      }
      const memoryContext = memorySettings.enabled ? await retrieveMemoryContext(trimmed) : "";
      const memoryTokens = memoryContext ? estimateTokens(memoryContext) : 0;
      sessionMemoryBoost.set(sessionKey, memoryTokens);
      updateContextBar(sessionKey);
      const outboundMessage = memoryContext
        ? `[[Memory Context]]\n${memoryContext}\n[[End Memory Context]]\n\nUser:\n${trimmed}`
        : trimmed;
      try {
        const ack = await invoke("chat_send", { payload: { sessionKey, message: outboundMessage } });
        lastChatRunId = ack?.runId || null;
        activeChatRunId = lastChatRunId;
        if (lastChatRunId) {
          runStartTimes.set(lastChatRunId, Date.now());
        }
        lastChatEventAt = Date.now();
        stallNotified = false;
        startStallWatcher();
        if (appendUser) {
          appendMemoryMessage("user", trimmed);
        }
        setChatStatus("Awaiting response...", "text-slate-400");
        return true;
      } catch (error) {
        if (allowAutoRetry) {
          const retried = await attemptAutoRetry(String(error));
          if (retried) return true;
        }
        setChatStatus(`Send failed: ${String(error)}`, "text-red-400");
        return false;
      }
    };

    const attemptAutoRetry = async (errorText = "") => {
      if (!activeTabId) return false;
      const attempts = autoRetryAttempts.get(activeTabId) || 0;
      if (attempts >= 1) return false;
      const lastMessage = lastUserMessageByTab.get(activeTabId);
      if (!lastMessage) return false;
      autoRetryAttempts.set(activeTabId, attempts + 1);
      setChatStatus("Auto-retrying last message...", "text-amber-400");
      await sendMessageWithMemory(lastMessage, { appendUser: false, allowAutoRetry: false });
      return true;
    };

    const sendChat = async () => {
      const input = document.getElementById("chat-input");
      const message = input ? input.value.trim() : "";
      if (!message) return;
      if (input) input.value = "";
      await sendMessageWithMemory(message, { appendUser: true, allowAutoRetry: true });
    };

    const stopChat = async () => {
      if (!invoke) return;
      const sessionKey = getChatSessionKey();
      if (!sessionKey) return;
      try {
        await invoke("chat_abort", { payload: { sessionKey, runId: lastChatRunId } });
        setChatStatus("Stop requested.", "text-amber-400");
        stopStallWatcher();
      } catch (error) {
        setChatStatus(`Stop failed: ${String(error)}`, "text-red-400");
      }
    };

    const handleChatEvent = async (payload) => {
      if (!payload) return;
      const sessionKey = payload.sessionKey || "";
      if (sessionKey && sessionKey !== getChatSessionKey()) return;
      const rawState = payload.state || "delta";
      const state = rawState === "thinking" || rawState === "analysis" ? "delta" : rawState;
      const runId = payload.runId || payload.clientRunId || "";
      if (runId) {
        activeChatRunId = runId;
        lastChatEventAt = Date.now();
        stallNotified = false;
        startStallWatcher();
        if (!runStartTimes.has(runId)) {
          runStartTimes.set(runId, Date.now());
        }
      }
      if (state === "delta") {
        const parts = extractMessageParts(payload.message);
        updateChatRun(runId, parts, sessionKey, state);
      } else if (state === "final") {
        const parts = extractMessageParts(payload.message);
        const toolError = parseToolErrorPayload(parts.text);
        if (toolError) {
          appendGatewayLog(`tool error: ${toolError}`, "text-amber-400");
          setChatStatus("Tool auth error — check Agent Config.", "text-amber-400");
          chatRuns.delete(runId);
          runTokenCounts.delete(runId);
          stopStallWatcher();
          return;
        }
        updateChatRun(runId, parts, sessionKey, state);
        const finalText = (parts.text || "").trim().toUpperCase();
        if (finalText === "NO_REPLY") {
          resetSessionForActiveTab();
          const input = document.getElementById("chat-input");
          const lastMessage = activeTabId ? lastUserMessageByTab.get(activeTabId) : "";
          if (input && lastMessage) {
            input.value = lastMessage;
          }
          setChatStatus("No reply from agent. Session reset — press Send to retry.", "text-amber-400");
          chatRuns.delete(runId);
          runTokenCounts.delete(runId);
          stopStallWatcher();
          return;
        }
        if (parts.text) {
          appendMemoryMessage("assistant", parts.text);
          recordDashboardMessage("assistant", parts.text, {
            agentId: selectedAgentId,
            agentName: getAgentName(selectedAgent),
            modelLabel: resolveAgentModelKey(selectedAgent) || currentDefaultModelKey,
          });
        }
        if (runId && runStartTimes.has(runId)) {
          const startedAt = runStartTimes.get(runId);
          runStartTimes.delete(runId);
          if (startedAt) {
            recordDashboardRun(Date.now() - startedAt);
          }
        }
        if (activeTabId) {
          autoRetryAttempts.set(activeTabId, 0);
        }
        chatRuns.delete(runId);
        runTokenCounts.delete(runId);
        stopStallWatcher();
        setChatStatus("Response complete.", "text-emerald-400");
      } else if (state === "error") {
        const didRetry = await attemptAutoRetry(payload.errorMessage || "");
        if (didRetry) {
          stopStallWatcher();
          return;
        }
        appendChatMessage({
          role: "assistant",
          text: payload.errorMessage || "Error",
          timestamp: Date.now(),
          state: "error",
          sessionKey,
        });
        stopStallWatcher();
        setChatStatus("Response error.", "text-red-400");
      }
    };

    const runDetection = async () => {
      if (!invoke) {
        setLog(["tauri global not found", "enable app.withGlobalTauri in tauri.conf.json"]);
        return;
      }
      setStatus(document.getElementById("oc-status-binary"), "SCANNING", "text-amber-400");
      setStatus(document.getElementById("oc-status-version"), "SCANNING", "text-amber-400");
      setStatus(document.getElementById("oc-status-config"), "SCANNING", "text-amber-400");
      setLog(["scanning for openclaw..."]);

      try {
        const data = await invoke("detect_openclaw");
        updateDetection(data);
      } catch (error) {
        setLog(["scan failed", String(error)]);
        setStatus(document.getElementById("oc-status-binary"), "ERROR", "text-red-400");
      }
    };

    const loadSettings = async () => {
      if (!invoke) return;
      try {
        const settings = await invoke("get_settings");
        cachedSettings = settings;
        const workspaceInput = document.getElementById("workspace-path");
        const skillsInput = document.getElementById("skills-path");
        if (!profileManagedPaths) {
          if (workspaceInput) workspaceInput.value = settings.workspace_path || "";
          if (skillsInput) skillsInput.value = settings.skills_path || "";
        }

        const heartbeatEnabled = document.getElementById("heartbeat-enabled");
        const heartbeatInterval = document.getElementById("heartbeat-interval");
        const heartbeatStatus = document.getElementById("heartbeat-status");
        const heartbeatButton = document.getElementById("save-heartbeat");
        if (heartbeatEnabled) heartbeatEnabled.checked = !!settings.heartbeat_enabled;
        if (heartbeatInterval) heartbeatInterval.value = settings.heartbeat_interval_minutes || 30;
        if (heartbeatPolicyDisabled) {
          if (heartbeatEnabled) {
            heartbeatEnabled.checked = false;
            heartbeatEnabled.disabled = true;
            heartbeatEnabled.classList.add("opacity-60", "cursor-not-allowed");
          }
          if (heartbeatInterval) {
            heartbeatInterval.disabled = true;
            heartbeatInterval.classList.add("opacity-60", "cursor-not-allowed");
          }
          if (heartbeatButton) {
            heartbeatButton.disabled = true;
            heartbeatButton.classList.add("opacity-60", "cursor-not-allowed");
          }
          if (heartbeatStatus) {
            heartbeatStatus.textContent = "Heartbeat disabled (activity-based detection).";
          }
        }

        const authCards = document.querySelectorAll("[data-auth-provider]");
        authCards.forEach((card) => {
          const name = card.getAttribute("data-auth-provider");
          const methodSelect = card.querySelector("[data-auth-method]");
          const provider = (settings.provider_auth || []).find((p) => p.name === name);
          if (provider && methodSelect) {
            methodSelect.value = provider.method || "cli";
          }
        });

        const memoryEnabled = document.getElementById("memory-enabled");
        const memoryUrl = document.getElementById("memory-url");
        const memoryMaxRecent = document.getElementById("memory-max-recent");
        const memoryConfig = getMemorySettings();
        if (memoryEnabled) memoryEnabled.checked = !!memoryConfig.enabled;
        if (memoryUrl) memoryUrl.value = memoryConfig.url || memoryDefaults.url;
        if (memoryMaxRecent) memoryMaxRecent.value = memoryConfig.maxRecent || memoryDefaults.maxRecent;
        updateMemoryStatus(memoryConfig.enabled ? "Memory engine enabled." : "Memory engine disabled.", memoryConfig.enabled ? "text-emerald-400" : "text-slate-500");
      } catch (error) {
        console.error("Failed to load settings", error);
      }
    };

    const savePaths = async () => {
      if (!invoke) return;
      const workspaceInput = document.getElementById("workspace-path");
      const skillsInput = document.getElementById("skills-path");
      const statusEl = document.getElementById("paths-status");
      const workspace = workspaceInput ? workspaceInput.value.trim() : "";
      const skills = skillsInput ? skillsInput.value.trim() : "";
      if (!workspace || !skills) {
        if (statusEl) statusEl.textContent = "Both paths are required.";
        return;
      }
      const validation = await invoke("validate_paths", {
        workspacePath: workspace,
        skillsPath: skills,
      });
      if (!validation.workspace_exists || !validation.skills_exists) {
        if (statusEl) {
          statusEl.textContent = `Missing: ${!validation.workspace_exists ? "workspace" : ""} ${!validation.skills_exists ? "skills" : ""}`.trim();
        }
      }

      const nextSettings = cachedSettings || {};
      nextSettings.workspace_path = workspace;
      nextSettings.skills_path = skills;
      try {
        cachedSettings = await invoke("save_settings", { settings: nextSettings });
        if (statusEl) {
          statusEl.textContent = profileManagedPaths ? "Paths saved (profile-managed)." : "Paths saved.";
        }
      } catch (error) {
        if (statusEl) statusEl.textContent = "Failed to save paths.";
      }
    };

    const saveHeartbeat = async () => {
      if (!invoke) return;
      if (heartbeatPolicyDisabled) {
        const statusEl = document.getElementById("heartbeat-status");
        if (statusEl) statusEl.textContent = "Heartbeat disabled by policy.";
        return;
      }
      const enabledEl = document.getElementById("heartbeat-enabled");
      const intervalEl = document.getElementById("heartbeat-interval");
      const statusEl = document.getElementById("heartbeat-status");
      const enabled = enabledEl ? enabledEl.checked : false;
      const interval = intervalEl ? Number(intervalEl.value) : 30;
      if (!interval || interval < 1) {
        if (statusEl) statusEl.textContent = "Interval must be at least 1 minute.";
        return;
      }
      const nextSettings = cachedSettings || {};
      nextSettings.heartbeat_enabled = enabled;
      nextSettings.heartbeat_interval_minutes = interval;
      try {
        cachedSettings = await invoke("save_settings", { settings: nextSettings });
        if (statusEl) statusEl.textContent = `Heartbeat ${enabled ? "enabled" : "disabled"} at ${interval}m.`;
        try {
          await invoke("gateway_request", { method: "set-heartbeats", params: { enabled } });
          appendGatewayLog(`set-heartbeats: ${enabled ? "enabled" : "disabled"}`, "text-emerald-400");
        } catch (error) {
          appendGatewayLog(`set-heartbeats error: ${String(error)}`, "text-red-400");
        }
      } catch (error) {
        if (statusEl) statusEl.textContent = "Failed to save heartbeat.";
      }
    };

    const saveProviderAuth = async (card) => {
      if (!invoke || !card) return;
      const provider = card.getAttribute("data-auth-provider");
      const methodEl = card.querySelector("[data-auth-method]");
      const statusEl = card.querySelector(".text-[10px].font-mono");
      const method = methodEl ? methodEl.value : "cli";
      const nextSettings = cachedSettings || {};
      const auth = Array.isArray(nextSettings.provider_auth) ? nextSettings.provider_auth : [];
      const existing = auth.find((p) => p.name === provider);
      if (existing) {
        existing.method = method;
      } else {
        auth.push({ name: provider, method });
      }
      nextSettings.provider_auth = auth;
      try {
        cachedSettings = await invoke("save_settings", { settings: nextSettings });
        if (statusEl) statusEl.textContent = `SAVED (${method.toUpperCase()})`;
      } catch (error) {
        if (statusEl) statusEl.textContent = "SAVE FAILED";
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const storedSidebar = localStorage.getItem(sidebarHiddenKey) === "true";
      applySidebarHidden(storedSidebar);
      const storedGatewayUrl = localStorage.getItem("dieah.gatewayUrl");
      const gatewayUrlInput = document.getElementById("gateway-url");
      if (gatewayUrlInput) {
        gatewayUrlInput.value = storedGatewayUrl || "ws://127.0.0.1:18789";
      }
      const ocLogCopy = document.getElementById("oc-log-copy");
      if (ocLogCopy) {
        ocLogCopy.addEventListener("click", async () => {
          const log = document.getElementById("oc-log");
          const text = log ? log.innerText.trim() : "";
          const copied = await copyText(text);
          ocLogCopy.textContent = copied ? "Copied" : "Copy failed";
          window.setTimeout(() => {
            ocLogCopy.textContent = "Copy";
          }, 1200);
        });
      }
      const authHelperCopy = document.getElementById("auth-helper-copy");
      if (authHelperCopy) {
        authHelperCopy.addEventListener("click", async () => {
          const copied = await copyText(authHelperText);
          authHelperCopy.textContent = copied ? "Copied" : "Copy failed";
          window.setTimeout(() => {
            authHelperCopy.textContent = "Copy";
          }, 1200);
        });
      }
      const rescanButton = document.getElementById("oc-rescan");
      if (rescanButton) {
        rescanButton.addEventListener("click", runDetection);
      }
      const agentConfigNew = document.getElementById("agent-config-new");
      if (agentConfigNew) {
        agentConfigNew.addEventListener("click", () => {
          setAgentConfigCollapsed(false);
          const step = document.getElementById("step-1");
          if (step) step.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      }
      const overviewNew = document.getElementById("overview-new-assistant");
      if (overviewNew) {
        overviewNew.addEventListener("click", () => {
          setView("setup");
          setAgentConfigCollapsed(false);
          const step = document.getElementById("step-1");
          if (step) step.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      }
      const overviewViewAll = document.getElementById("overview-view-all");
      if (overviewViewAll) {
        overviewViewAll.addEventListener("click", (event) => {
          event.preventDefault();
          setView("agents");
        });
      }
      const navOverview = document.getElementById("nav-overview");
      if (navOverview) {
        navOverview.addEventListener("click", (event) => {
          event.preventDefault();
          setView("overview");
        });
      }
      const navSkills = document.getElementById("nav-skills");
      if (navSkills) {
        navSkills.addEventListener("click", async (event) => {
          event.preventDefault();
          setView("skills");
          await refreshSkills();
        });
      }
      const navSetup = document.getElementById("nav-setup");
      if (navSetup) {
        navSetup.addEventListener("click", (event) => {
          event.preventDefault();
          setView("setup");
        });
      }
      const navSettings = document.getElementById("nav-settings");
      if (navSettings) {
        navSettings.addEventListener("click", (event) => {
          event.preventDefault();
          setView("settings");
        });
      }
      const sidebarToggle = document.getElementById("sidebar-toggle");
      if (sidebarToggle) {
        sidebarToggle.addEventListener("click", toggleSidebar);
      }
      const sidebarToggleOverview = document.getElementById("sidebar-toggle-overview");
      if (sidebarToggleOverview) {
        sidebarToggleOverview.addEventListener("click", toggleSidebar);
      }
      const navAgents = document.getElementById("nav-agents");
      if (navAgents) {
        navAgents.addEventListener("click", async (event) => {
          event.preventDefault();
          setView("agents");
          await loadChatAgents();
        });
      }
      const providersViewAll = document.getElementById("providers-viewall");
      if (providersViewAll) {
        providersViewAll.addEventListener("click", () => {
          const step = document.getElementById("step-3");
          if (step) step.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      }
      const gatewayConnectButton = document.getElementById("gateway-connect");
      if (gatewayConnectButton) {
        gatewayConnectButton.addEventListener("click", connectGateway);
      }
      const gatewayDisconnectButton = document.getElementById("gateway-disconnect");
      if (gatewayDisconnectButton) {
        gatewayDisconnectButton.addEventListener("click", disconnectGateway);
      }
      const gatewayTokenUse = document.getElementById("gateway-token-use");
      if (gatewayTokenUse) {
        gatewayTokenUse.addEventListener("click", async () => {
          const tokenInput = document.getElementById("gateway-token");
          const profile = getProfileArg();
          const cachedToken = getCachedGatewayToken();
          if (cachedToken) {
            if (tokenInput) tokenInput.value = cachedToken;
            gatewayAuto.token = cachedToken;
            appendGatewayLog("inserted cached token", "text-emerald-400");
            return;
          }
          try {
            const info = await invoke("openclaw_dashboard_token", { profile });
            if (info && info.token) {
              if (tokenInput) tokenInput.value = info.token;
              gatewayAuto.token = info.token;
              setCachedGatewayToken(info.token);
              appendGatewayLog("inserted profile token", "text-emerald-400");
              return;
            }
          } catch (error) {
            appendGatewayLog(`token fetch error: ${String(error)}`, "text-red-400");
          }
          if (gatewayAuto.token) {
            if (tokenInput) tokenInput.value = gatewayAuto.token;
            appendGatewayLog("inserted profile token (cached)", "text-emerald-400");
          }
        });
      }
      const gatewayTokenCopy = document.getElementById("gateway-token-copy");
      if (gatewayTokenCopy) {
        gatewayTokenCopy.addEventListener("click", async () => {
          const profile = getProfileArg();
          const cmd = profile ? `openclaw --profile ${profile} dashboard --no-open` : "openclaw dashboard --no-open";
          const ok = await copyText(cmd);
          gatewayTokenCopy.textContent = ok ? "Copied" : "Copy failed";
          window.setTimeout(() => {
            gatewayTokenCopy.textContent = "Copy";
          }, 1200);
        });
      }
      loadCachedAgents();
      renderAgentRail();
      const cachedAgent = localStorage.getItem("dieah.chatAgent") || getDefaultAgent();
      if (cachedAgent && cachedAgents.length) {
        selectAgent(cachedAgent, { skipHistory: true });
      }
      const chatTabAdd = document.getElementById("chat-tab-add");
      if (chatTabAdd) {
        chatTabAdd.addEventListener("click", () => {
          if (!selectedAgentId) {
            setChatStatus("Select an agent first.", "text-amber-400");
            return;
          }
          const tabs = getTabsForAgent(selectedAgentId);
          const next = createNewTab(selectedAgentId);
          tabs.push(next);
          saveTabsForAgent(selectedAgentId, tabs);
          setActiveTab(next.id);
        });
      }
      const chatAgentAdd = document.getElementById("chat-agent-add");
      if (chatAgentAdd) {
        chatAgentAdd.addEventListener("click", openAgentModal);
      }
      const chatAgentSettings = document.getElementById("chat-agent-settings");
      if (chatAgentSettings) {
        chatAgentSettings.addEventListener("click", () => {
          setChatStatus("Agent settings coming soon.", "text-slate-400");
        });
      }
      const agentModalClose = document.getElementById("chat-agent-modal-close");
      if (agentModalClose) {
        agentModalClose.addEventListener("click", closeAgentModal);
      }
      const agentModalCancel = document.getElementById("chat-agent-modal-cancel");
      if (agentModalCancel) {
        agentModalCancel.addEventListener("click", closeAgentModal);
      }
      const agentModalCreate = document.getElementById("chat-agent-modal-create");
      if (agentModalCreate) {
        agentModalCreate.addEventListener("click", createAgent);
      }
      const agentModalInput = document.getElementById("chat-agent-name");
      if (agentModalInput) {
        agentModalInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            createAgent();
          }
        });
      }
      const agentModal = document.getElementById("chat-agent-modal");
      if (agentModal) {
        agentModal.addEventListener("click", (event) => {
          if (event.target === agentModal) {
            closeAgentModal();
          }
        });
      }
      const chatSendButton = document.getElementById("chat-send");
      if (chatSendButton) {
        chatSendButton.addEventListener("click", sendChat);
      }
      const chatStopButton = document.getElementById("chat-stop");
      if (chatStopButton) {
        chatStopButton.addEventListener("click", stopChat);
      }
      const chatInput = document.getElementById("chat-input");
      if (chatInput) {
        chatInput.addEventListener("focus", () => {
          if (!gatewayConnected && !gatewayConnecting) {
            autoReconnectIfNeeded();
          }
        });
        chatInput.addEventListener("keydown", (event) => {
          if (!gatewayConnected && !gatewayConnecting) {
            autoReconnectIfNeeded();
          }
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendChat();
          }
        });
      }
      const gatewayClearButton = document.getElementById("gateway-log-clear");
      if (gatewayClearButton) {
        gatewayClearButton.addEventListener("click", () => {
          const log = document.getElementById("gateway-log");
          if (log) log.innerHTML = "";
        });
      }
      const memorySaveButton = document.getElementById("memory-save");
      if (memorySaveButton) {
        memorySaveButton.addEventListener("click", saveMemorySettings);
      }
      const memoryTestButton = document.getElementById("memory-test");
      if (memoryTestButton) {
        memoryTestButton.addEventListener("click", testMemoryConnection);
      }
      const settingsResetButton = document.getElementById("settings-reset");
      if (settingsResetButton) {
        settingsResetButton.addEventListener("click", resetMemoryDefaults);
      }
      const providerLoginButtons = document.querySelectorAll("[data-provider-login]");
      providerLoginButtons.forEach((btn) => {
        btn.addEventListener("click", (event) => {
          const card = event.target.closest("[data-provider]");
          const provider = card ? card.getAttribute("data-provider") : null;
          if (provider) {
            handleProviderLogin(provider, btn);
          }
        });
      });
      const savePathsButton = document.getElementById("save-paths");
      if (savePathsButton) {
        savePathsButton.addEventListener("click", savePaths);
      }
      const profileSelect = document.getElementById("profile-select");
      if (profileSelect) {
        profileSelect.addEventListener("change", (event) => {
          const value = event.target ? event.target.value : "default";
          scheduleApplyProfile(value);
        });
      }
      const profileNew = document.getElementById("profile-new");
      if (profileNew) {
        profileNew.addEventListener("click", () => {
          showToast("Starting new profile...");
          startNewProfile();
        });
      }
      const profileRefresh = document.getElementById("profile-refresh");
      if (profileRefresh) {
        profileRefresh.addEventListener("click", loadProfiles);
      }
      const saveHeartbeatButton = document.getElementById("save-heartbeat");
      if (saveHeartbeatButton) {
        saveHeartbeatButton.addEventListener("click", saveHeartbeat);
      }
      const authButtons = document.querySelectorAll("[data-auth-save]");
      authButtons.forEach((btn) => {
        btn.addEventListener("click", (event) => {
          const card = event.target.closest("[data-auth-provider]");
          saveProviderAuth(card);
        });
      });
      const skillsRefresh = document.getElementById("skills-refresh");
      if (skillsRefresh) {
        skillsRefresh.addEventListener("click", refreshSkills);
      }
      const skillsFilterCurated = document.getElementById("skills-filter-curated");
      if (skillsFilterCurated) {
        skillsFilterCurated.addEventListener("click", () => setSkillsFilter("curated"));
      }
      const skillsFilterAll = document.getElementById("skills-filter-all");
      if (skillsFilterAll) {
        skillsFilterAll.addEventListener("click", () => setSkillsFilter("all"));
      }
      const agentsRefresh = document.getElementById("agents-refresh");
      if (agentsRefresh) {
        agentsRefresh.addEventListener("click", refreshAgents);
      }
      const skillsList = document.getElementById("skills-list");
      if (skillsList) {
        skillsList.addEventListener("click", async (event) => {
          const installBtn = event.target.closest("[data-skill-install]");
          if (installBtn) {
            const name = installBtn.getAttribute("data-skill-name") || "";
            const installId = installBtn.getAttribute("data-install-id") || "";
            if (!name || !installId) return;
            installBtn.textContent = "Installing...";
            try {
              await invoke("gateway_request", {
                method: "skills.install",
                params: { name, installId, timeoutMs: 600000 },
              });
              appendGatewayLog(`skills.install ok: ${name}`, "text-emerald-400");
            } catch (error) {
              appendGatewayLog(`skills.install error: ${String(error)}`, "text-red-400");
            }
            await refreshSkills();
            return;
          }
          const toggleBtn = event.target.closest("[data-skill-toggle]");
          if (toggleBtn) {
            const skillKey = toggleBtn.getAttribute("data-skill-key") || "";
            const enabled = toggleBtn.getAttribute("data-skill-enabled") === "true";
            if (!skillKey) return;
            toggleBtn.textContent = enabled ? "Enabling..." : "Disabling...";
            try {
              await invoke("gateway_request", {
                method: "skills.update",
                params: { skillKey, enabled },
              });
              appendGatewayLog(`skills.update ok: ${skillKey}`, "text-emerald-400");
            } catch (error) {
              appendGatewayLog(`skills.update error: ${String(error)}`, "text-red-400");
            }
            await refreshSkills();
          }
        });
      }

      if (listen) {
        listen("gateway-status", (event) => {
          const payload = event.payload || {};
          const status = payload.status || "unknown";
          const reason = payload.reason ? ` (${payload.reason})` : "";
          if (status === "connecting") {
            gatewayConnecting = true;
            updateGatewayState("CONNECTING", "Dialing gateway...", "text-amber-400", "bg-amber-500", true);
            if (reconnectRequested) {
              showConnToast("Reconnecting to gateway...");
            }
          } else if (status === "open") {
            gatewayConnecting = true;
            updateGatewayState("OPEN", "Socket open, waiting for handshake.", "text-amber-400", "bg-amber-500", true);
            if (reconnectRequested) {
              showConnToast("Reconnecting to gateway...");
            }
          } else if (status === "closed") {
            gatewayConnected = false;
            gatewayConnecting = false;
            updateGatewayState("CLOSED", `Socket closed${reason}.`, "text-red-400", "bg-red-500");
            setAgentConfigCollapsed(false);
            if (reconnectRequested && !gatewayConnected) {
              scheduleReconnectFailure();
            }
          } else if (status === "error") {
            gatewayConnected = false;
            gatewayConnecting = false;
            updateGatewayState("ERROR", `Gateway error${reason}.`, "text-red-400", "bg-red-500");
            setAgentConfigCollapsed(false);
            if (reconnectRequested && !gatewayConnected) {
              scheduleReconnectFailure();
            }
          } else if (status === "disconnected") {
            gatewayConnected = false;
            gatewayConnecting = false;
            updateGatewayState("IDLE", "Disconnected.", "text-slate-500", "bg-slate-600");
            setAgentConfigCollapsed(false);
            if (reconnectRequested && !gatewayConnected) {
              scheduleReconnectFailure();
            }
          }
          appendGatewayLog(`status: ${status}${reason}`, status === "error" ? "text-red-400" : "text-slate-400");
        });

        listen("gateway-hello", (event) => {
          gatewayConnected = true;
          gatewayConnecting = false;
          updateGatewayState("READY", "Gateway handshake complete.", "text-emerald-400", "bg-emerald-500");
          setOverviewLoading("Loading existing models...", true);
          const payload = event.payload || {};
          if (payload && typeof payload === "object") {
            appendGatewayLog(`hello: protocol ${payload.protocol ?? "?"}`, "text-emerald-400");
          }
          if (lastGatewayTokenUsed) {
            setCachedGatewayToken(lastGatewayTokenUsed);
          }
          localStorage.setItem("dieah.gatewayAutoConnect", "true");
          if (reconnectRequested) {
            hideConnToast();
            reconnectRequested = false;
          }
          if (heartbeatPolicyDisabled) {
            invoke("gateway_request", { method: "set-heartbeats", params: { enabled: false } })
              .then(() => appendGatewayLog("set-heartbeats: disabled (policy)", "text-amber-400"))
              .catch((error) => appendGatewayLog(`set-heartbeats error: ${String(error)}`, "text-red-400"));
          }
          Promise.all([refreshSkills(), refreshAgents(), loadChatAgents()]);
          autoLaunchDefaultAgent();
          setAgentConfigCollapsed(true);
        });

        listen("chat-event", (event) => {
          const payload = event.payload || {};
          handleChatEvent(payload);
          const state = payload.state || "event";
          const run = payload.runId ? String(payload.runId).slice(0, 8) : "run";
          let preview = "";
          if (payload.message) {
            if (typeof payload.message === "string") {
              preview = payload.message;
            } else if (payload.message.content && Array.isArray(payload.message.content)) {
              const firstText = payload.message.content.find((item) => item.type === "text");
              if (firstText && firstText.text) {
                preview = firstText.text;
              }
            }
          }
          if (preview.length > 120) {
            preview = preview.slice(0, 120) + "…";
          }
          const tone = state === "error" ? "text-red-400" : state === "final" ? "text-emerald-400" : "text-slate-300";
          appendGatewayLog(`[chat:${state}] ${run} ${preview}`, tone);
        });

        listen("agent-event", (event) => {
          const payload = event.payload || {};
          const state = payload.state || payload.type || "agent";
          const run = payload.runId ? String(payload.runId).slice(0, 8) : "run";
          appendGatewayLog(`[agent:${state}] ${run}`, "text-slate-400");
        });
      }

      applySkillsFilter();
      setOverviewLoading("Loading existing models...", true);
      Promise.all([runDetection(), loadProfiles(), loadSettings()]);
      initOverviewChart();
      updateDashboard();
      setView("overview");
    });
  </script>
</body>
</html>
